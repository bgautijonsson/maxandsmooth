<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE article PUBLIC "-//NLM//DTD JATS (Z39.96) Journal Archiving
and Interchange DTD v1.2 20190208//EN" "JATS-archivearticle1.dtd">
<article xmlns:mml="http://www.w3.org/1998/Math/MathML" xmlns:xlink="http://www.w3.org/1999/xlink" dtd-version="1.2" article-type="other">
  <front>
    <article-meta>
      <title-group>
        <article-title>Applying Max-and-Smooth to the UKCP data</article-title>
      </title-group>
      <contrib-group>
        <contrib contrib-type="author">
          <name>
            <surname>Jónsson</surname>
            <given-names>Brynjólfur Gauti Guðrúnar</given-names>
          </name>
          <string-name>Brynjólfur Gauti Guðrúnar Jónsson</string-name>
        </contrib>
      </contrib-group>
      <history/>
    </article-meta>
  </front>
  <body>
    <sec id="introduction">
      <title>Introduction</title>
      <p>This document describes the implementation of the Max-and-Smooth
  algorithm for fast approximate Bayesian inference in spatial extreme
  value analysis of climate projections provided by the UKCP. The
  algorithm is specifically applied to Generalized Extreme Value (GEV)
  distributions and is implemented in C++ with R interfaces using Rcpp
  and RcppEigen as well as Stan.</p>
      <sec id="package-overview">
        <title>Package Overview</title>
        <p>The <monospace>maxandsmooth</monospace> R package provides tools
    for fast approximate Bayesian inference for spatial GEV models. The
    core of the package is implemented in C++ for efficiency, with R
    wrappers for ease of use.</p>
        <p>Key features of the package include:</p>
        <list list-type="bullet">
          <list-item>
            <p>Implementation of the Max-and-Smooth algorithm</p>
          </list-item>
          <list-item>
            <p>Efficient C++ code using automatic differentiation and
        Eigen</p>
          </list-item>
          <list-item>
            <p>Spatial modeling of GEV parameters using Stan’s efficient HMC
        sampler</p>
          </list-item>
          <list-item>
            <p>R interface for easy integration into existing extreme value
        analysis workflows</p>
          </list-item>
        </list>
      </sec>
      <sec id="algorithm-description">
        <title>Algorithm Description</title>
        <p>The Max-and-Smooth algorithm, as applied to spatial GEV models,
    consists of two main steps:</p>
        <list list-type="order">
          <list-item>
            <p><bold>Max Step</bold>: Maximum likelihood estimation of GEV
        parameters at each spatial location using C++</p>
          </list-item>
          <list-item>
            <p><bold>Smooth Step</bold>: Spatial smoothing of the maximum
        likelihood estimates using a BYM2 model implemented in Stan</p>
          </list-item>
        </list>
        <p>The algorithm treats the ML estimates as sufficient statistics
    for a latent Gaussian field, providing a fast approximation to full
    Bayesian inference for spatial extreme value models.</p>
      </sec>
      <sec id="code-structure">
        <title>Code Structure</title>
        <p>The package is organized into several key files:</p>
        <list list-type="order">
          <list-item>
            <p><monospace>src/max.cpp</monospace>: Implements the Max step
        (maximum likelihood estimation for GEV)</p>
          </list-item>
          <list-item>
            <p><monospace>src/gev.cpp</monospace>: Implements GEV-specific
        functions for likelihood and gradient calculations</p>
          </list-item>
          <list-item>
            <p><monospace>Stan/stan_smooth_bym2.stan</monospace> Implements
        the Smooth step using Stan</p>
          </list-item>
        </list>
      </sec>
    </sec>
    <sec id="max-step">
      <title>Max Step</title>
      <p>The Max step involves computing location-wise maximum likelihood
  estimates (MLEs) for the GEV model parameters. This step is performed
  independently for each location, treating the data as if it were
  independent across locations.</p>
      <sec id="data-structure">
        <title>Data Structure</title>
        <p>The input data Y, calculated from the UKCP, is structured as a
    matrix, where:</p>
        <list list-type="bullet">
          <list-item>
            <p>Rows represent observations of hourly maximum rainfall in
        yearly blocks</p>
          </list-item>
          <list-item>
            <p>Columns represent different spatial locations over Great
        Britain.</p>
          </list-item>
        </list>
      </sec>
      <sec id="maximum-likelihood-estimation">
        <title>Maximum Likelihood Estimation</title>
        <p>For each location (column in Y), we compute the MLEs for the
    three GEV parameters: location <inline-formula><alternatives><tex-math><![CDATA[(\mu)]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:mrow><mml:mo stretchy="true" form="prefix">(</mml:mo><mml:mi>μ</mml:mi><mml:mo stretchy="true" form="postfix">)</mml:mo></mml:mrow></mml:math></alternatives></inline-formula>,
    scale <inline-formula><alternatives><tex-math><![CDATA[(\sigma)]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:mrow><mml:mo stretchy="true" form="prefix">(</mml:mo><mml:mi>σ</mml:mi><mml:mo stretchy="true" form="postfix">)</mml:mo></mml:mrow></mml:math></alternatives></inline-formula>,
    and shape <inline-formula><alternatives><tex-math><![CDATA[(\xi)]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:mrow><mml:mo stretchy="true" form="prefix">(</mml:mo><mml:mi>ξ</mml:mi><mml:mo stretchy="true" form="postfix">)</mml:mo></mml:mrow></mml:math></alternatives></inline-formula>.
    The log-likelihood function for the GEV distribution at a single
    location is:</p>
        <p>
          <disp-formula>
            <alternatives>
              <tex-math><![CDATA[
    \ell(\mu, \sigma, \xi | y) = -n\log\sigma - (1+\frac{1}{\xi})\sum_{i=1}^n \log\left(1+\xi\frac{y_i-\mu}{\sigma}\right) - \sum_{i=1}^n \left(1+\xi\frac{y_i-\mu}{\sigma}\right)^{-1/\xi}
    ]]></tex-math>
              <mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="block">
                <mml:mrow>
                  <mml:mo>ℓ</mml:mo>
                  <mml:mrow>
                    <mml:mo stretchy="true" form="prefix">(</mml:mo>
                    <mml:mi>μ</mml:mi>
                    <mml:mo>,</mml:mo>
                    <mml:mi>σ</mml:mi>
                    <mml:mo>,</mml:mo>
                    <mml:mi>ξ</mml:mi>
                    <mml:mo stretchy="false" form="prefix">|</mml:mo>
                    <mml:mi>y</mml:mi>
                    <mml:mo stretchy="true" form="postfix">)</mml:mo>
                  </mml:mrow>
                  <mml:mo>=</mml:mo>
                  <mml:mi>−</mml:mi>
                  <mml:mi>n</mml:mi>
                  <mml:mo>log</mml:mo>
                  <mml:mi>σ</mml:mi>
                  <mml:mo>−</mml:mo>
                  <mml:mrow>
                    <mml:mo stretchy="true" form="prefix">(</mml:mo>
                    <mml:mn>1</mml:mn>
                    <mml:mo>+</mml:mo>
                    <mml:mfrac>
                      <mml:mn>1</mml:mn>
                      <mml:mi>ξ</mml:mi>
                    </mml:mfrac>
                    <mml:mo stretchy="true" form="postfix">)</mml:mo>
                  </mml:mrow>
                  <mml:munderover>
                    <mml:mo>∑</mml:mo>
                    <mml:mrow>
                      <mml:mi>i</mml:mi>
                      <mml:mo>=</mml:mo>
                      <mml:mn>1</mml:mn>
                    </mml:mrow>
                    <mml:mi>n</mml:mi>
                  </mml:munderover>
                  <mml:mo>log</mml:mo>
                  <mml:mrow>
                    <mml:mo stretchy="true" form="prefix">(</mml:mo>
                    <mml:mn>1</mml:mn>
                    <mml:mo>+</mml:mo>
                    <mml:mi>ξ</mml:mi>
                    <mml:mfrac>
                      <mml:mrow>
                        <mml:msub>
                          <mml:mi>y</mml:mi>
                          <mml:mi>i</mml:mi>
                        </mml:msub>
                        <mml:mo>−</mml:mo>
                        <mml:mi>μ</mml:mi>
                      </mml:mrow>
                      <mml:mi>σ</mml:mi>
                    </mml:mfrac>
                    <mml:mo stretchy="true" form="postfix">)</mml:mo>
                  </mml:mrow>
                  <mml:mo>−</mml:mo>
                  <mml:munderover>
                    <mml:mo>∑</mml:mo>
                    <mml:mrow>
                      <mml:mi>i</mml:mi>
                      <mml:mo>=</mml:mo>
                      <mml:mn>1</mml:mn>
                    </mml:mrow>
                    <mml:mi>n</mml:mi>
                  </mml:munderover>
                  <mml:msup>
                    <mml:mrow>
                      <mml:mo stretchy="true" form="prefix">(</mml:mo>
                      <mml:mn>1</mml:mn>
                      <mml:mo>+</mml:mo>
                      <mml:mi>ξ</mml:mi>
                      <mml:mfrac>
                        <mml:mrow>
                          <mml:msub>
                            <mml:mi>y</mml:mi>
                            <mml:mi>i</mml:mi>
                          </mml:msub>
                          <mml:mo>−</mml:mo>
                          <mml:mi>μ</mml:mi>
                        </mml:mrow>
                        <mml:mi>σ</mml:mi>
                      </mml:mfrac>
                      <mml:mo stretchy="true" form="postfix">)</mml:mo>
                    </mml:mrow>
                    <mml:mrow>
                      <mml:mi>−</mml:mi>
                      <mml:mn>1</mml:mn>
                      <mml:mi>/</mml:mi>
                      <mml:mi>ξ</mml:mi>
                    </mml:mrow>
                  </mml:msup>
                </mml:mrow>
              </mml:math>
            </alternatives>
          </disp-formula>
        </p>
        <p>where <inline-formula><alternatives><tex-math><![CDATA[n]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:mi>n</mml:mi></mml:math></alternatives></inline-formula>
    is the number of observations at the location.</p>
        <p>The MLEs are obtained by maximizing this likelihood function with
    respect to the parameters:</p>
        <p>
          <disp-formula>
            <alternatives>
              <tex-math><![CDATA[
    (\hat{\mu}_i, \hat{\sigma}_i, \hat{\xi}_i) = \arg\max_{(\mu, \sigma, \xi)} \ell(\mu, \sigma, \xi | Y_i)
    ]]></tex-math>
              <mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="block">
                <mml:mrow>
                  <mml:mrow>
                    <mml:mo stretchy="true" form="prefix">(</mml:mo>
                    <mml:msub>
                      <mml:mover>
                        <mml:mi>μ</mml:mi>
                        <mml:mo accent="true">̂</mml:mo>
                      </mml:mover>
                      <mml:mi>i</mml:mi>
                    </mml:msub>
                    <mml:mo>,</mml:mo>
                    <mml:msub>
                      <mml:mover>
                        <mml:mi>σ</mml:mi>
                        <mml:mo accent="true">̂</mml:mo>
                      </mml:mover>
                      <mml:mi>i</mml:mi>
                    </mml:msub>
                    <mml:mo>,</mml:mo>
                    <mml:msub>
                      <mml:mover>
                        <mml:mi>ξ</mml:mi>
                        <mml:mo accent="true">̂</mml:mo>
                      </mml:mover>
                      <mml:mi>i</mml:mi>
                    </mml:msub>
                    <mml:mo stretchy="true" form="postfix">)</mml:mo>
                  </mml:mrow>
                  <mml:mo>=</mml:mo>
                  <mml:mo>arg</mml:mo>
                  <mml:munder>
                    <mml:mo>max</mml:mo>
                    <mml:mrow>
                      <mml:mo stretchy="true" form="prefix">(</mml:mo>
                      <mml:mi>μ</mml:mi>
                      <mml:mo>,</mml:mo>
                      <mml:mi>σ</mml:mi>
                      <mml:mo>,</mml:mo>
                      <mml:mi>ξ</mml:mi>
                      <mml:mo stretchy="true" form="postfix">)</mml:mo>
                    </mml:mrow>
                  </mml:munder>
                  <mml:mo>ℓ</mml:mo>
                  <mml:mrow>
                    <mml:mo stretchy="true" form="prefix">(</mml:mo>
                    <mml:mi>μ</mml:mi>
                    <mml:mo>,</mml:mo>
                    <mml:mi>σ</mml:mi>
                    <mml:mo>,</mml:mo>
                    <mml:mi>ξ</mml:mi>
                    <mml:mo stretchy="false" form="prefix">|</mml:mo>
                    <mml:msub>
                      <mml:mi>Y</mml:mi>
                      <mml:mi>i</mml:mi>
                    </mml:msub>
                    <mml:mo stretchy="true" form="postfix">)</mml:mo>
                  </mml:mrow>
                </mml:mrow>
              </mml:math>
            </alternatives>
          </disp-formula>
        </p>
        <p>where <inline-formula><alternatives><tex-math><![CDATA[Y_i]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:msub><mml:mi>Y</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:math></alternatives></inline-formula>
    is the data for location <inline-formula><alternatives><tex-math><![CDATA[i]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:mi>i</mml:mi></mml:math></alternatives></inline-formula>.</p>
        <sec id="link-functions">
          <title>Link Functions</title>
          <p>Instead of directly maximizing the likelihood with the original
      parameters, we transform the parameters using a link function</p>
          <p>
            <disp-formula>
              <alternatives>
                <tex-math><![CDATA[
      \left(\psi, \tau, \phi\right) = h(\mu, \sigma, \xi) = \left(\log(\mu), \log(\sigma) - \log(\mu), \text{logit}(\xi)\right)
      ]]></tex-math>
                <mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="block">
                  <mml:mrow>
                    <mml:mrow>
                      <mml:mo stretchy="true" form="prefix">(</mml:mo>
                      <mml:mi>ψ</mml:mi>
                      <mml:mo>,</mml:mo>
                      <mml:mi>τ</mml:mi>
                      <mml:mo>,</mml:mo>
                      <mml:mi>ϕ</mml:mi>
                      <mml:mo stretchy="true" form="postfix">)</mml:mo>
                    </mml:mrow>
                    <mml:mo>=</mml:mo>
                    <mml:mi>h</mml:mi>
                    <mml:mrow>
                      <mml:mo stretchy="true" form="prefix">(</mml:mo>
                      <mml:mi>μ</mml:mi>
                      <mml:mo>,</mml:mo>
                      <mml:mi>σ</mml:mi>
                      <mml:mo>,</mml:mo>
                      <mml:mi>ξ</mml:mi>
                      <mml:mo stretchy="true" form="postfix">)</mml:mo>
                    </mml:mrow>
                    <mml:mo>=</mml:mo>
                    <mml:mrow>
                      <mml:mo stretchy="true" form="prefix">(</mml:mo>
                      <mml:mo>log</mml:mo>
                      <mml:mrow>
                        <mml:mo stretchy="true" form="prefix">(</mml:mo>
                        <mml:mi>μ</mml:mi>
                        <mml:mo stretchy="true" form="postfix">)</mml:mo>
                      </mml:mrow>
                      <mml:mo>,</mml:mo>
                      <mml:mo>log</mml:mo>
                      <mml:mrow>
                        <mml:mo stretchy="true" form="prefix">(</mml:mo>
                        <mml:mi>σ</mml:mi>
                        <mml:mo stretchy="true" form="postfix">)</mml:mo>
                      </mml:mrow>
                      <mml:mo>−</mml:mo>
                      <mml:mo>log</mml:mo>
                      <mml:mrow>
                        <mml:mo stretchy="true" form="prefix">(</mml:mo>
                        <mml:mi>μ</mml:mi>
                        <mml:mo stretchy="true" form="postfix">)</mml:mo>
                      </mml:mrow>
                      <mml:mo>,</mml:mo>
                      <mml:mtext mathvariant="normal">logit</mml:mtext>
                      <mml:mrow>
                        <mml:mo stretchy="true" form="prefix">(</mml:mo>
                        <mml:mi>ξ</mml:mi>
                        <mml:mo stretchy="true" form="postfix">)</mml:mo>
                      </mml:mrow>
                      <mml:mo stretchy="true" form="postfix">)</mml:mo>
                    </mml:mrow>
                  </mml:mrow>
                </mml:math>
              </alternatives>
            </disp-formula>
          </p>
        </sec>
      </sec>
      <sec id="implementation">
        <title>Implementation</title>
        <p>The maximization is performed using numerical optimization
    techniques. In our C++ implementation, we use the following
    approach:</p>
        <list list-type="order">
          <list-item>
            <p>Parameters are transformed with a link function</p>
          </list-item>
          <list-item>
            <p>The negative log-likelihood and its gradient are computed on
        the unconstrained scale</p>
          </list-item>
          <list-item>
            <p>A numerical optimizer is used to find the MLEs as well as the
        Hessians at each location’s optimum.</p>
          </list-item>
        </list>
        <p>The output of this step includes:</p>
        <list list-type="order">
          <list-item>
            <p>A vector of parameter estimates,
        <inline-formula><alternatives><tex-math><![CDATA[\hat\eta]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:mover><mml:mi>η</mml:mi><mml:mo accent="true">̂</mml:mo></mml:mover></mml:math></alternatives></inline-formula>,
        ordered such that each station’s location parameter appears
        first, followed by scale parameters, then shape parameters:</p>
            <p>
              <disp-formula>
                <alternatives>
                  <tex-math><![CDATA[
        \hat{\eta} = (\hat{\psi}_1, \ldots, \hat{\psi}_n, \hat{\tau}_1, \ldots, \hat{\tau}_n, \hat{\phi}_1, \ldots, \hat{\phi}_n)^T
        ]]></tex-math>
                  <mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="block">
                    <mml:mrow>
                      <mml:mover>
                        <mml:mi>η</mml:mi>
                        <mml:mo accent="true">̂</mml:mo>
                      </mml:mover>
                      <mml:mo>=</mml:mo>
                      <mml:msup>
                        <mml:mrow>
                          <mml:mo stretchy="true" form="prefix">(</mml:mo>
                          <mml:msub>
                            <mml:mover>
                              <mml:mi>ψ</mml:mi>
                              <mml:mo accent="true">̂</mml:mo>
                            </mml:mover>
                            <mml:mn>1</mml:mn>
                          </mml:msub>
                          <mml:mo>,</mml:mo>
                          <mml:mi>…</mml:mi>
                          <mml:mo>,</mml:mo>
                          <mml:msub>
                            <mml:mover>
                              <mml:mi>ψ</mml:mi>
                              <mml:mo accent="true">̂</mml:mo>
                            </mml:mover>
                            <mml:mi>n</mml:mi>
                          </mml:msub>
                          <mml:mo>,</mml:mo>
                          <mml:msub>
                            <mml:mover>
                              <mml:mi>τ</mml:mi>
                              <mml:mo accent="true">̂</mml:mo>
                            </mml:mover>
                            <mml:mn>1</mml:mn>
                          </mml:msub>
                          <mml:mo>,</mml:mo>
                          <mml:mi>…</mml:mi>
                          <mml:mo>,</mml:mo>
                          <mml:msub>
                            <mml:mover>
                              <mml:mi>τ</mml:mi>
                              <mml:mo accent="true">̂</mml:mo>
                            </mml:mover>
                            <mml:mi>n</mml:mi>
                          </mml:msub>
                          <mml:mo>,</mml:mo>
                          <mml:msub>
                            <mml:mover>
                              <mml:mi>ϕ</mml:mi>
                              <mml:mo accent="true">̂</mml:mo>
                            </mml:mover>
                            <mml:mn>1</mml:mn>
                          </mml:msub>
                          <mml:mo>,</mml:mo>
                          <mml:mi>…</mml:mi>
                          <mml:mo>,</mml:mo>
                          <mml:msub>
                            <mml:mover>
                              <mml:mi>ϕ</mml:mi>
                              <mml:mo accent="true">̂</mml:mo>
                            </mml:mover>
                            <mml:mi>n</mml:mi>
                          </mml:msub>
                          <mml:mo stretchy="true" form="postfix">)</mml:mo>
                        </mml:mrow>
                        <mml:mi>T</mml:mi>
                      </mml:msup>
                    </mml:mrow>
                  </mml:math>
                </alternatives>
              </disp-formula>
            </p>
            <p>where <inline-formula><alternatives><tex-math><![CDATA[n]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:mi>n</mml:mi></mml:math></alternatives></inline-formula>
        is the number of stations.</p>
          </list-item>
          <list-item>
            <p>A precision matrix, <inline-formula><alternatives><tex-math><![CDATA[Q_{\eta y}]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:msub><mml:mi>Q</mml:mi><mml:mrow><mml:mi>η</mml:mi><mml:mi>y</mml:mi></mml:mrow></mml:msub></mml:math></alternatives></inline-formula>,
        constructed from the negative Hessians of the log-likelihood at
        the MLE estimates. Due to the parameter ordering in
        <inline-formula><alternatives><tex-math><![CDATA[\hat\eta]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:mover><mml:mi>η</mml:mi><mml:mo accent="true">̂</mml:mo></mml:mover></mml:math></alternatives></inline-formula>,
        <inline-formula><alternatives><tex-math><![CDATA[Q_{\eta y}]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:msub><mml:mi>Q</mml:mi><mml:mrow><mml:mi>η</mml:mi><mml:mi>y</mml:mi></mml:mrow></mml:msub></mml:math></alternatives></inline-formula>
        can be described as a 3×3 block matrix:</p>
            <p>
              <disp-formula>
                <alternatives>
                  <tex-math><![CDATA[
        Q_{\eta y} = \begin{bmatrix}
        Q_{\psi\psi} & Q_{\psi\tau} & Q_{\psi\phi} \\
        Q_{\tau\psi} & Q_{\tau\tau} & Q_{\tau\phi} \\
        Q_{\phi\psi} & Q_{\psi\tau} & Q_{\phi\phi}
        \end{bmatrix}
        ]]></tex-math>
                  <mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="block">
                    <mml:mrow>
                      <mml:msub>
                        <mml:mi>Q</mml:mi>
                        <mml:mrow>
                          <mml:mi>η</mml:mi>
                          <mml:mi>y</mml:mi>
                        </mml:mrow>
                      </mml:msub>
                      <mml:mo>=</mml:mo>
                      <mml:mrow>
                        <mml:mo stretchy="true" form="prefix">[</mml:mo>
                        <mml:mtable>
                          <mml:mtr>
                            <mml:mtd columnalign="center" style="text-align: center">
                              <mml:msub>
                                <mml:mi>Q</mml:mi>
                                <mml:mrow>
                                  <mml:mi>ψ</mml:mi>
                                  <mml:mi>ψ</mml:mi>
                                </mml:mrow>
                              </mml:msub>
                            </mml:mtd>
                            <mml:mtd columnalign="center" style="text-align: center">
                              <mml:msub>
                                <mml:mi>Q</mml:mi>
                                <mml:mrow>
                                  <mml:mi>ψ</mml:mi>
                                  <mml:mi>τ</mml:mi>
                                </mml:mrow>
                              </mml:msub>
                            </mml:mtd>
                            <mml:mtd columnalign="center" style="text-align: center">
                              <mml:msub>
                                <mml:mi>Q</mml:mi>
                                <mml:mrow>
                                  <mml:mi>ψ</mml:mi>
                                  <mml:mi>ϕ</mml:mi>
                                </mml:mrow>
                              </mml:msub>
                            </mml:mtd>
                          </mml:mtr>
                          <mml:mtr>
                            <mml:mtd columnalign="center" style="text-align: center">
                              <mml:msub>
                                <mml:mi>Q</mml:mi>
                                <mml:mrow>
                                  <mml:mi>τ</mml:mi>
                                  <mml:mi>ψ</mml:mi>
                                </mml:mrow>
                              </mml:msub>
                            </mml:mtd>
                            <mml:mtd columnalign="center" style="text-align: center">
                              <mml:msub>
                                <mml:mi>Q</mml:mi>
                                <mml:mrow>
                                  <mml:mi>τ</mml:mi>
                                  <mml:mi>τ</mml:mi>
                                </mml:mrow>
                              </mml:msub>
                            </mml:mtd>
                            <mml:mtd columnalign="center" style="text-align: center">
                              <mml:msub>
                                <mml:mi>Q</mml:mi>
                                <mml:mrow>
                                  <mml:mi>τ</mml:mi>
                                  <mml:mi>ϕ</mml:mi>
                                </mml:mrow>
                              </mml:msub>
                            </mml:mtd>
                          </mml:mtr>
                          <mml:mtr>
                            <mml:mtd columnalign="center" style="text-align: center">
                              <mml:msub>
                                <mml:mi>Q</mml:mi>
                                <mml:mrow>
                                  <mml:mi>ϕ</mml:mi>
                                  <mml:mi>ψ</mml:mi>
                                </mml:mrow>
                              </mml:msub>
                            </mml:mtd>
                            <mml:mtd columnalign="center" style="text-align: center">
                              <mml:msub>
                                <mml:mi>Q</mml:mi>
                                <mml:mrow>
                                  <mml:mi>ψ</mml:mi>
                                  <mml:mi>τ</mml:mi>
                                </mml:mrow>
                              </mml:msub>
                            </mml:mtd>
                            <mml:mtd columnalign="center" style="text-align: center">
                              <mml:msub>
                                <mml:mi>Q</mml:mi>
                                <mml:mrow>
                                  <mml:mi>ϕ</mml:mi>
                                  <mml:mi>ϕ</mml:mi>
                                </mml:mrow>
                              </mml:msub>
                            </mml:mtd>
                          </mml:mtr>
                        </mml:mtable>
                        <mml:mo stretchy="true" form="postfix">]</mml:mo>
                      </mml:mrow>
                    </mml:mrow>
                  </mml:math>
                </alternatives>
              </disp-formula>
            </p>
            <p>where each block <inline-formula><alternatives><tex-math><![CDATA[Q_{ij}]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:msub><mml:mi>Q</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:math></alternatives></inline-formula>
        is an <inline-formula><alternatives><tex-math><![CDATA[n \times n]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:mrow><mml:mi>n</mml:mi><mml:mo>×</mml:mo><mml:mi>n</mml:mi></mml:mrow></mml:math></alternatives></inline-formula>
        diagonal matrix. The diagonal elements of
        <inline-formula><alternatives><tex-math><![CDATA[Q_{ii}]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:msub><mml:mi>Q</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></alternatives></inline-formula>
        correspond to the negative second derivatives of the
        log-likelihood with respect to the
        <inline-formula><alternatives><tex-math><![CDATA[i]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:mi>i</mml:mi></mml:math></alternatives></inline-formula>-th
        parameter at each station. The off-diagonal blocks
        <inline-formula><alternatives><tex-math><![CDATA[Q_{ij}]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:msub><mml:mi>Q</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:math></alternatives></inline-formula>
        (where <inline-formula><alternatives><tex-math><![CDATA[i \neq j]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:mrow><mml:mi>i</mml:mi><mml:mo>≠</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:math></alternatives></inline-formula>)
        contain the negative mixed partial derivatives of the
        log-likelihood with respect to the
        <inline-formula><alternatives><tex-math><![CDATA[i]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:mi>i</mml:mi></mml:math></alternatives></inline-formula>-th
        and <inline-formula><alternatives><tex-math><![CDATA[j]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:mi>j</mml:mi></mml:math></alternatives></inline-formula>-th
        parameters.</p>
            <p>For example, the elements of <inline-formula><alternatives><tex-math><![CDATA[Q_{\psi\psi}]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:msub><mml:mi>Q</mml:mi><mml:mrow><mml:mi>ψ</mml:mi><mml:mi>ψ</mml:mi></mml:mrow></mml:msub></mml:math></alternatives></inline-formula>
        are the conditional precisions of the location parameters:</p>
            <p>
              <disp-formula>
                <alternatives>
                  <tex-math><![CDATA[
        \begin{aligned}
        Q_{\psi\psi} &=  \text{diag}\left(\tau^{\psi\psi}_1, \dots, \tau^{\psi\psi}_n\right)\\
        &= \text{diag}\left(-\frac{\partial^2 \ell(Y_1|\psi_1,\tau_1,\phi_1)}{\partial \psi_1^2}, \ldots, -\frac{\partial^2 \ell(Y_n|\psi_n,\tau_n,\phi_n)}{\partial \psi_n^2}\right),
        \end{aligned}
        ]]></tex-math>
                  <mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="block">
                    <mml:mtable>
                      <mml:mtr>
                        <mml:mtd columnalign="right" style="text-align: right">
                          <mml:msub>
                            <mml:mi>Q</mml:mi>
                            <mml:mrow>
                              <mml:mi>ψ</mml:mi>
                              <mml:mi>ψ</mml:mi>
                            </mml:mrow>
                          </mml:msub>
                        </mml:mtd>
                        <mml:mtd columnalign="left" style="text-align: left">
                          <mml:mo>=</mml:mo>
                          <mml:mtext mathvariant="normal">diag</mml:mtext>
                          <mml:mrow>
                            <mml:mo stretchy="true" form="prefix">(</mml:mo>
                            <mml:msubsup>
                              <mml:mi>τ</mml:mi>
                              <mml:mn>1</mml:mn>
                              <mml:mrow>
                                <mml:mi>ψ</mml:mi>
                                <mml:mi>ψ</mml:mi>
                              </mml:mrow>
                            </mml:msubsup>
                            <mml:mo>,</mml:mo>
                            <mml:mi>…</mml:mi>
                            <mml:mo>,</mml:mo>
                            <mml:msubsup>
                              <mml:mi>τ</mml:mi>
                              <mml:mi>n</mml:mi>
                              <mml:mrow>
                                <mml:mi>ψ</mml:mi>
                                <mml:mi>ψ</mml:mi>
                              </mml:mrow>
                            </mml:msubsup>
                            <mml:mo stretchy="true" form="postfix">)</mml:mo>
                          </mml:mrow>
                        </mml:mtd>
                      </mml:mtr>
                      <mml:mtr>
                        <mml:mtd columnalign="right" style="text-align: right"/>
                        <mml:mtd columnalign="left" style="text-align: left">
                          <mml:mo>=</mml:mo>
                          <mml:mtext mathvariant="normal">diag</mml:mtext>
                          <mml:mrow>
                            <mml:mo stretchy="true" form="prefix">(</mml:mo>
                            <mml:mi>−</mml:mi>
                            <mml:mfrac>
                              <mml:mrow>
                                <mml:msup>
                                  <mml:mi>∂</mml:mi>
                                  <mml:mn>2</mml:mn>
                                </mml:msup>
                                <mml:mo>ℓ</mml:mo>
                                <mml:mrow>
                                  <mml:mo stretchy="true" form="prefix">(</mml:mo>
                                  <mml:msub>
                                    <mml:mi>Y</mml:mi>
                                    <mml:mn>1</mml:mn>
                                  </mml:msub>
                                  <mml:mo stretchy="false" form="prefix">|</mml:mo>
                                  <mml:msub>
                                    <mml:mi>ψ</mml:mi>
                                    <mml:mn>1</mml:mn>
                                  </mml:msub>
                                  <mml:mo>,</mml:mo>
                                  <mml:msub>
                                    <mml:mi>τ</mml:mi>
                                    <mml:mn>1</mml:mn>
                                  </mml:msub>
                                  <mml:mo>,</mml:mo>
                                  <mml:msub>
                                    <mml:mi>ϕ</mml:mi>
                                    <mml:mn>1</mml:mn>
                                  </mml:msub>
                                  <mml:mo stretchy="true" form="postfix">)</mml:mo>
                                </mml:mrow>
                              </mml:mrow>
                              <mml:mrow>
                                <mml:mi>∂</mml:mi>
                                <mml:msubsup>
                                  <mml:mi>ψ</mml:mi>
                                  <mml:mn>1</mml:mn>
                                  <mml:mn>2</mml:mn>
                                </mml:msubsup>
                              </mml:mrow>
                            </mml:mfrac>
                            <mml:mo>,</mml:mo>
                            <mml:mi>…</mml:mi>
                            <mml:mo>,</mml:mo>
                            <mml:mi>−</mml:mi>
                            <mml:mfrac>
                              <mml:mrow>
                                <mml:msup>
                                  <mml:mi>∂</mml:mi>
                                  <mml:mn>2</mml:mn>
                                </mml:msup>
                                <mml:mo>ℓ</mml:mo>
                                <mml:mrow>
                                  <mml:mo stretchy="true" form="prefix">(</mml:mo>
                                  <mml:msub>
                                    <mml:mi>Y</mml:mi>
                                    <mml:mi>n</mml:mi>
                                  </mml:msub>
                                  <mml:mo stretchy="false" form="prefix">|</mml:mo>
                                  <mml:msub>
                                    <mml:mi>ψ</mml:mi>
                                    <mml:mi>n</mml:mi>
                                  </mml:msub>
                                  <mml:mo>,</mml:mo>
                                  <mml:msub>
                                    <mml:mi>τ</mml:mi>
                                    <mml:mi>n</mml:mi>
                                  </mml:msub>
                                  <mml:mo>,</mml:mo>
                                  <mml:msub>
                                    <mml:mi>ϕ</mml:mi>
                                    <mml:mi>n</mml:mi>
                                  </mml:msub>
                                  <mml:mo stretchy="true" form="postfix">)</mml:mo>
                                </mml:mrow>
                              </mml:mrow>
                              <mml:mrow>
                                <mml:mi>∂</mml:mi>
                                <mml:msubsup>
                                  <mml:mi>ψ</mml:mi>
                                  <mml:mi>n</mml:mi>
                                  <mml:mn>2</mml:mn>
                                </mml:msubsup>
                              </mml:mrow>
                            </mml:mfrac>
                            <mml:mo stretchy="true" form="postfix">)</mml:mo>
                          </mml:mrow>
                          <mml:mo>,</mml:mo>
                        </mml:mtd>
                      </mml:mtr>
                    </mml:mtable>
                  </mml:math>
                </alternatives>
              </disp-formula>
            </p>
            <p>and the elements of <inline-formula><alternatives><tex-math><![CDATA[Q_{\mu\xi}]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:msub><mml:mi>Q</mml:mi><mml:mrow><mml:mi>μ</mml:mi><mml:mi>ξ</mml:mi></mml:mrow></mml:msub></mml:math></alternatives></inline-formula>
        are the conditional dependencies between the location and shape
        parameters:</p>
            <p>
              <disp-formula>
                <alternatives>
                  <tex-math><![CDATA[
        \begin{aligned}
        Q_{\psi\phi} &= \text{diag}\left(\tau^{\psi\phi}_1, \dots, \tau^{\psi\phi}_n\right) \\
        &= \text{diag}\left(-\frac{\partial^2 \ell(Y_1|\psi_1,\tau_1,\phi_1)}{\partial \psi_1\partial \phi_1}, \ldots, -\frac{\partial^2 \ell(Y_n|\psi_n,\tau_n,\phi_n)}{\partial \psi_n\partial \phi_n}\right)
        \end{aligned}
        ]]></tex-math>
                  <mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="block">
                    <mml:mtable>
                      <mml:mtr>
                        <mml:mtd columnalign="right" style="text-align: right">
                          <mml:msub>
                            <mml:mi>Q</mml:mi>
                            <mml:mrow>
                              <mml:mi>ψ</mml:mi>
                              <mml:mi>ϕ</mml:mi>
                            </mml:mrow>
                          </mml:msub>
                        </mml:mtd>
                        <mml:mtd columnalign="left" style="text-align: left">
                          <mml:mo>=</mml:mo>
                          <mml:mtext mathvariant="normal">diag</mml:mtext>
                          <mml:mrow>
                            <mml:mo stretchy="true" form="prefix">(</mml:mo>
                            <mml:msubsup>
                              <mml:mi>τ</mml:mi>
                              <mml:mn>1</mml:mn>
                              <mml:mrow>
                                <mml:mi>ψ</mml:mi>
                                <mml:mi>ϕ</mml:mi>
                              </mml:mrow>
                            </mml:msubsup>
                            <mml:mo>,</mml:mo>
                            <mml:mi>…</mml:mi>
                            <mml:mo>,</mml:mo>
                            <mml:msubsup>
                              <mml:mi>τ</mml:mi>
                              <mml:mi>n</mml:mi>
                              <mml:mrow>
                                <mml:mi>ψ</mml:mi>
                                <mml:mi>ϕ</mml:mi>
                              </mml:mrow>
                            </mml:msubsup>
                            <mml:mo stretchy="true" form="postfix">)</mml:mo>
                          </mml:mrow>
                        </mml:mtd>
                      </mml:mtr>
                      <mml:mtr>
                        <mml:mtd columnalign="right" style="text-align: right"/>
                        <mml:mtd columnalign="left" style="text-align: left">
                          <mml:mo>=</mml:mo>
                          <mml:mtext mathvariant="normal">diag</mml:mtext>
                          <mml:mrow>
                            <mml:mo stretchy="true" form="prefix">(</mml:mo>
                            <mml:mi>−</mml:mi>
                            <mml:mfrac>
                              <mml:mrow>
                                <mml:msup>
                                  <mml:mi>∂</mml:mi>
                                  <mml:mn>2</mml:mn>
                                </mml:msup>
                                <mml:mo>ℓ</mml:mo>
                                <mml:mrow>
                                  <mml:mo stretchy="true" form="prefix">(</mml:mo>
                                  <mml:msub>
                                    <mml:mi>Y</mml:mi>
                                    <mml:mn>1</mml:mn>
                                  </mml:msub>
                                  <mml:mo stretchy="false" form="prefix">|</mml:mo>
                                  <mml:msub>
                                    <mml:mi>ψ</mml:mi>
                                    <mml:mn>1</mml:mn>
                                  </mml:msub>
                                  <mml:mo>,</mml:mo>
                                  <mml:msub>
                                    <mml:mi>τ</mml:mi>
                                    <mml:mn>1</mml:mn>
                                  </mml:msub>
                                  <mml:mo>,</mml:mo>
                                  <mml:msub>
                                    <mml:mi>ϕ</mml:mi>
                                    <mml:mn>1</mml:mn>
                                  </mml:msub>
                                  <mml:mo stretchy="true" form="postfix">)</mml:mo>
                                </mml:mrow>
                              </mml:mrow>
                              <mml:mrow>
                                <mml:mi>∂</mml:mi>
                                <mml:msub>
                                  <mml:mi>ψ</mml:mi>
                                  <mml:mn>1</mml:mn>
                                </mml:msub>
                                <mml:mi>∂</mml:mi>
                                <mml:msub>
                                  <mml:mi>ϕ</mml:mi>
                                  <mml:mn>1</mml:mn>
                                </mml:msub>
                              </mml:mrow>
                            </mml:mfrac>
                            <mml:mo>,</mml:mo>
                            <mml:mi>…</mml:mi>
                            <mml:mo>,</mml:mo>
                            <mml:mi>−</mml:mi>
                            <mml:mfrac>
                              <mml:mrow>
                                <mml:msup>
                                  <mml:mi>∂</mml:mi>
                                  <mml:mn>2</mml:mn>
                                </mml:msup>
                                <mml:mo>ℓ</mml:mo>
                                <mml:mrow>
                                  <mml:mo stretchy="true" form="prefix">(</mml:mo>
                                  <mml:msub>
                                    <mml:mi>Y</mml:mi>
                                    <mml:mi>n</mml:mi>
                                  </mml:msub>
                                  <mml:mo stretchy="false" form="prefix">|</mml:mo>
                                  <mml:msub>
                                    <mml:mi>ψ</mml:mi>
                                    <mml:mi>n</mml:mi>
                                  </mml:msub>
                                  <mml:mo>,</mml:mo>
                                  <mml:msub>
                                    <mml:mi>τ</mml:mi>
                                    <mml:mi>n</mml:mi>
                                  </mml:msub>
                                  <mml:mo>,</mml:mo>
                                  <mml:msub>
                                    <mml:mi>ϕ</mml:mi>
                                    <mml:mi>n</mml:mi>
                                  </mml:msub>
                                  <mml:mo stretchy="true" form="postfix">)</mml:mo>
                                </mml:mrow>
                              </mml:mrow>
                              <mml:mrow>
                                <mml:mi>∂</mml:mi>
                                <mml:msub>
                                  <mml:mi>ψ</mml:mi>
                                  <mml:mi>n</mml:mi>
                                </mml:msub>
                                <mml:mi>∂</mml:mi>
                                <mml:msub>
                                  <mml:mi>ϕ</mml:mi>
                                  <mml:mi>n</mml:mi>
                                </mml:msub>
                              </mml:mrow>
                            </mml:mfrac>
                            <mml:mo stretchy="true" form="postfix">)</mml:mo>
                          </mml:mrow>
                        </mml:mtd>
                      </mml:mtr>
                    </mml:mtable>
                  </mml:math>
                </alternatives>
              </disp-formula>
            </p>
          </list-item>
        </list>
        <p>This structure reflects the independence assumption between
    stations in the Max step, while capturing the parameter dependencies
    within each station. The outputs, <inline-formula><alternatives><tex-math><![CDATA[\hat \eta]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:mover><mml:mi>η</mml:mi><mml:mo accent="true">̂</mml:mo></mml:mover></mml:math></alternatives></inline-formula>
    and <inline-formula><alternatives><tex-math><![CDATA[Q_{\eta y}]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:msub><mml:mi>Q</mml:mi><mml:mrow><mml:mi>η</mml:mi><mml:mi>y</mml:mi></mml:mrow></mml:msub></mml:math></alternatives></inline-formula>,
    serve as inputs into the Smooth step.</p>
      </sec>
    </sec>
    <sec id="smooth-step">
      <title>Smooth Step</title>
      <p>The Smooth step involves Bayesian inference on a latent Gaussian
  field, using the maximum likelihood estimates from the Max step as
  data. We implement this step using Stan, which provides efficient
  Hamiltonian Monte Carlo sampling.</p>
      <sec id="model-structure">
        <title>Model Structure</title>
        <p>Let <inline-formula><alternatives><tex-math><![CDATA[\eta]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:mi>η</mml:mi></mml:math></alternatives></inline-formula>
    be the latent field of parameters, and
    <inline-formula><alternatives><tex-math><![CDATA[\hat{\eta}]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:mover><mml:mi>η</mml:mi><mml:mo accent="true">̂</mml:mo></mml:mover></mml:math></alternatives></inline-formula>
    be the maximum likelihood estimates from the Max step. The model
    follows a BYM2 (Besag-York-Mollié) structure, which decomposes the
    spatial effect into structured and unstructured components:</p>
        <p>For each parameter <inline-formula><alternatives><tex-math><![CDATA[p \in \{\psi, \tau, \phi\}]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:mrow><mml:mi>p</mml:mi><mml:mo>∈</mml:mo><mml:mo stretchy="false" form="prefix">{</mml:mo><mml:mi>ψ</mml:mi><mml:mo>,</mml:mo><mml:mi>τ</mml:mi><mml:mo>,</mml:mo><mml:mi>ϕ</mml:mi><mml:mo stretchy="false" form="postfix">}</mml:mo></mml:mrow></mml:math></alternatives></inline-formula>:</p>
        <p>
          <disp-formula>
            <alternatives>
              <tex-math><![CDATA[
    \eta_p = \mu_p + \sigma_p\left(\eta^{\text{spatial}}_p\sqrt{\frac{\rho_p}{c}} + \eta^{\text{random}}_p\sqrt{1-\rho_p}\right)
    ]]></tex-math>
              <mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="block">
                <mml:mrow>
                  <mml:msub>
                    <mml:mi>η</mml:mi>
                    <mml:mi>p</mml:mi>
                  </mml:msub>
                  <mml:mo>=</mml:mo>
                  <mml:msub>
                    <mml:mi>μ</mml:mi>
                    <mml:mi>p</mml:mi>
                  </mml:msub>
                  <mml:mo>+</mml:mo>
                  <mml:msub>
                    <mml:mi>σ</mml:mi>
                    <mml:mi>p</mml:mi>
                  </mml:msub>
                  <mml:mrow>
                    <mml:mo stretchy="true" form="prefix">(</mml:mo>
                    <mml:msubsup>
                      <mml:mi>η</mml:mi>
                      <mml:mi>p</mml:mi>
                      <mml:mtext mathvariant="normal">spatial</mml:mtext>
                    </mml:msubsup>
                    <mml:msqrt>
                      <mml:mfrac>
                        <mml:msub>
                          <mml:mi>ρ</mml:mi>
                          <mml:mi>p</mml:mi>
                        </mml:msub>
                        <mml:mi>c</mml:mi>
                      </mml:mfrac>
                    </mml:msqrt>
                    <mml:mo>+</mml:mo>
                    <mml:msubsup>
                      <mml:mi>η</mml:mi>
                      <mml:mi>p</mml:mi>
                      <mml:mtext mathvariant="normal">random</mml:mtext>
                    </mml:msubsup>
                    <mml:msqrt>
                      <mml:mrow>
                        <mml:mn>1</mml:mn>
                        <mml:mo>−</mml:mo>
                        <mml:msub>
                          <mml:mi>ρ</mml:mi>
                          <mml:mi>p</mml:mi>
                        </mml:msub>
                      </mml:mrow>
                    </mml:msqrt>
                    <mml:mo stretchy="true" form="postfix">)</mml:mo>
                  </mml:mrow>
                </mml:mrow>
              </mml:math>
            </alternatives>
          </disp-formula>
        </p>
        <p>where:</p>
        <list list-type="bullet">
          <list-item>
            <p><inline-formula><alternatives><tex-math><![CDATA[\mu_p]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:msub><mml:mi>μ</mml:mi><mml:mi>p</mml:mi></mml:msub></mml:math></alternatives></inline-formula>
        is the overall mean for parameter <inline-formula><alternatives><tex-math><![CDATA[p]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:mi>p</mml:mi></mml:math></alternatives></inline-formula></p>
          </list-item>
          <list-item>
            <p><inline-formula><alternatives><tex-math><![CDATA[\sigma_p]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:msub><mml:mi>σ</mml:mi><mml:mi>p</mml:mi></mml:msub></mml:math></alternatives></inline-formula>
        is the marginal standard deviation</p>
          </list-item>
          <list-item>
            <p><inline-formula><alternatives><tex-math><![CDATA[\rho_p]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:msub><mml:mi>ρ</mml:mi><mml:mi>p</mml:mi></mml:msub></mml:math></alternatives></inline-formula>
        is the mixing parameter determining the balance between spatial
        and random effects</p>
          </list-item>
          <list-item>
            <p><inline-formula><alternatives><tex-math><![CDATA[c]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:mi>c</mml:mi></mml:math></alternatives></inline-formula>
        is a scaling factor that ensures the marginal variance of the
        spatial component is approximately 1</p>
          </list-item>
          <list-item>
            <p><inline-formula><alternatives><tex-math><![CDATA[\eta^{\text{spatial}}_p]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:msubsup><mml:mi>η</mml:mi><mml:mi>p</mml:mi><mml:mtext mathvariant="normal">spatial</mml:mtext></mml:msubsup></mml:math></alternatives></inline-formula>
        follows an intrinsic conditional autoregressive (ICAR) prior</p>
          </list-item>
          <list-item>
            <p><inline-formula><alternatives><tex-math><![CDATA[\eta^{\text{random}}_p]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:msubsup><mml:mi>η</mml:mi><mml:mi>p</mml:mi><mml:mtext mathvariant="normal">random</mml:mtext></mml:msubsup></mml:math></alternatives></inline-formula>
        follows a standard normal distribution</p>
          </list-item>
        </list>
        <sec id="data-level">
          <title>Data Level</title>
          <p>The data level models the relationship between the observed
      maximum likelihood estimates <inline-formula><alternatives><tex-math><![CDATA[\hat{\eta}]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:mover><mml:mi>η</mml:mi><mml:mo accent="true">̂</mml:mo></mml:mover></mml:math></alternatives></inline-formula>
      and the true latent field <inline-formula><alternatives><tex-math><![CDATA[\eta]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:mi>η</mml:mi></mml:math></alternatives></inline-formula>
      using a multivariate normal distribution with precision matrix
      <inline-formula><alternatives><tex-math><![CDATA[Q_{\eta y}]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:msub><mml:mi>Q</mml:mi><mml:mrow><mml:mi>η</mml:mi><mml:mi>y</mml:mi></mml:mrow></mml:msub></mml:math></alternatives></inline-formula>
      from the Max step:</p>
          <p>
            <disp-formula>
              <alternatives>
                <tex-math><![CDATA[\hat{\eta} | \eta \sim N(\eta, Q_{\eta y}^{-1})]]></tex-math>
                <mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="block">
                  <mml:mrow>
                    <mml:mover>
                      <mml:mi>η</mml:mi>
                      <mml:mo accent="true">̂</mml:mo>
                    </mml:mover>
                    <mml:mo stretchy="false" form="prefix">|</mml:mo>
                    <mml:mi>η</mml:mi>
                    <mml:mo>∼</mml:mo>
                    <mml:mi>N</mml:mi>
                    <mml:mrow>
                      <mml:mo stretchy="true" form="prefix">(</mml:mo>
                      <mml:mi>η</mml:mi>
                      <mml:mo>,</mml:mo>
                      <mml:msubsup>
                        <mml:mi>Q</mml:mi>
                        <mml:mrow>
                          <mml:mi>η</mml:mi>
                          <mml:mi>y</mml:mi>
                        </mml:mrow>
                        <mml:mrow>
                          <mml:mi>−</mml:mi>
                          <mml:mn>1</mml:mn>
                        </mml:mrow>
                      </mml:msubsup>
                      <mml:mo stretchy="true" form="postfix">)</mml:mo>
                    </mml:mrow>
                  </mml:mrow>
                </mml:math>
              </alternatives>
            </disp-formula>
          </p>
          <p>The precision matrix <inline-formula><alternatives><tex-math><![CDATA[Q_{\eta y}]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:msub><mml:mi>Q</mml:mi><mml:mrow><mml:mi>η</mml:mi><mml:mi>y</mml:mi></mml:mrow></mml:msub></mml:math></alternatives></inline-formula>
      is passed to Stan in a sparse representation and a custom
      likelihood function for multivariate Gaussian distributions with
      know Cholesky decomposed precision matrix is used.</p>
        </sec>
        <sec id="prior-distributions">
          <title>Prior Distributions</title>
          <p>The model uses the following prior distributions: what</p>
          <list list-type="bullet">
            <list-item>
              <p><inline-formula><alternatives><tex-math><![CDATA[\sigma_p \sim \text{Exponential}(1)]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:mrow><mml:msub><mml:mi>σ</mml:mi><mml:mi>p</mml:mi></mml:msub><mml:mo>∼</mml:mo><mml:mtext mathvariant="normal">Exponential</mml:mtext><mml:mrow><mml:mo stretchy="true" form="prefix">(</mml:mo><mml:mn>1</mml:mn><mml:mo stretchy="true" form="postfix">)</mml:mo></mml:mrow></mml:mrow></mml:math></alternatives></inline-formula>
          for the marginal standard deviations</p>
            </list-item>
            <list-item>
              <p><inline-formula><alternatives><tex-math><![CDATA[\rho_p \sim \text{Beta}(1,1)]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:mrow><mml:msub><mml:mi>ρ</mml:mi><mml:mi>p</mml:mi></mml:msub><mml:mo>∼</mml:mo><mml:mtext mathvariant="normal">Beta</mml:mtext><mml:mrow><mml:mo stretchy="true" form="prefix">(</mml:mo><mml:mn>1</mml:mn><mml:mo>,</mml:mo><mml:mn>1</mml:mn><mml:mo stretchy="true" form="postfix">)</mml:mo></mml:mrow></mml:mrow></mml:math></alternatives></inline-formula>
          for the mixing parameters</p>
            </list-item>
            <list-item>
              <p><inline-formula><alternatives><tex-math><![CDATA[\mu_p \sim 1]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:mrow><mml:msub><mml:mi>μ</mml:mi><mml:mi>p</mml:mi></mml:msub><mml:mo>∼</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:math></alternatives></inline-formula>
          for the overall means</p>
            </list-item>
          </list>
        </sec>
      </sec>
    </sec>
  </body>
  <back>
</back>
</article>

<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE article PUBLIC "-//NLM//DTD JATS (Z39.96) Journal Archiving
and Interchange DTD v1.2 20190208//EN" "JATS-archivearticle1.dtd">
<article xmlns:mml="http://www.w3.org/1998/Math/MathML" xmlns:xlink="http://www.w3.org/1999/xlink" dtd-version="1.2" article-type="other">
  <front>
    <article-meta>
      <title-group>
        <article-title>Applying Max-and-Smooth to the UKCP data</article-title>
      </title-group>
      <contrib-group>
        <contrib contrib-type="author">
          <name>
            <surname>Jónsson</surname>
            <given-names>Brynjólfur Gauti Guðrúnar</given-names>
          </name>
          <string-name>Brynjólfur Gauti Guðrúnar Jónsson</string-name>
        </contrib>
      </contrib-group>
      <history/>
    </article-meta>
  </front>
  <body>
    <sec id="introduction">
      <title>Introduction</title>
      <p>This document describes the implementation of the Max-and-Smooth
  algorithm for fast approximate Bayesian inference in spatial extreme
  value analysis of climate projections provided by the UKCP. The
  algorithm is specifically applied to Generalized Extreme Value (GEV)
  distributions and is implemented in C++ with R interfaces using Rcpp
  and RcppEigen.</p>
      <sec id="package-overview">
        <title>Package Overview</title>
        <p>The <monospace>maxandsmooth</monospace> R package provides tools
    for fast approximate Bayesian inference for spatial GEV models. The
    core of the package is implemented in C++ for efficiency, with R
    wrappers for ease of use.</p>
        <p>Key features of the package include:</p>
        <list list-type="bullet">
          <list-item>
            <p>Implementation of the Max-and-Smooth algorithm for GEV
        distributions</p>
          </list-item>
          <list-item>
            <p>Efficient C++ code using Eigen for linear algebra
        operations</p>
          </list-item>
          <list-item>
            <p>Spatial modeling of GEV parameters using Intrinsic
        Conditional Autoregressive (ICAR) priors</p>
          </list-item>
          <list-item>
            <p>R interface for easy integration into existing extreme value
        analysis workflows</p>
          </list-item>
        </list>
      </sec>
      <sec id="algorithm-description">
        <title>Algorithm Description</title>
        <p>The Max-and-Smooth algorithm, as applied to spatial GEV models,
    consists of two main steps:</p>
        <list list-type="order">
          <list-item>
            <p><bold>Max Step</bold>: Maximum likelihood estimation of GEV
        parameters at each spatial location</p>
          </list-item>
          <list-item>
            <p><bold>Smooth Step</bold>: Spatial smoothing of the maximum
        likelihood estimates using a latent Gaussian field</p>
          </list-item>
        </list>
        <p>The algorithm treats the ML estimates as sufficient statistics
    for a latent Gaussian field, providing a fast approximation to full
    Bayesian inference for spatial extreme value models.</p>
      </sec>
      <sec id="code-structure">
        <title>Code Structure</title>
        <p>The package is organized into several key files:</p>
        <list list-type="order">
          <list-item>
            <p><monospace>src/max.cpp</monospace>: Implements the Max step
        (maximum likelihood estimation for GEV)</p>
          </list-item>
          <list-item>
            <p><monospace>src/smooth.cpp</monospace>: Implements the Smooth
        step (latent Gaussian field smoothing)</p>
          </list-item>
          <list-item>
            <p><monospace>src/maxandsmooth.cpp</monospace>: Ties together
        the Max and Smooth steps</p>
          </list-item>
          <list-item>
            <p><monospace>src/gev.cpp</monospace>: Implements GEV-specific
        functions for likelihood and gradient calculations</p>
          </list-item>
        </list>
      </sec>
    </sec>
    <sec id="methods">
      <title>Methods</title>
      <sec id="max-step">
        <title>Max Step</title>
        <p>The Max step involves computing location-wise maximum likelihood
    estimates (MLEs) for the GEV model parameters. This step is
    performed independently for each location, treating the data as if
    it were independent across locations.</p>
        <sec id="data-structure">
          <title>Data Structure</title>
          <p>The input data Y, calculated from the UKCP, is structured as a
      matrix, where:</p>
          <list list-type="bullet">
            <list-item>
              <p>Rows represent observations of hourly maximum rainfall in
          yearly blocks</p>
            </list-item>
            <list-item>
              <p>Columns represent different spatial locations over Great
          Britain.</p>
            </list-item>
          </list>
        </sec>
        <sec id="maximum-likelihood-estimation">
          <title>Maximum Likelihood Estimation</title>
          <p>For each location (column in Y), we compute the MLEs for the
      three GEV parameters: location <inline-formula><alternatives><tex-math><![CDATA[(\mu)]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:mrow><mml:mo stretchy="true" form="prefix">(</mml:mo><mml:mi>μ</mml:mi><mml:mo stretchy="true" form="postfix">)</mml:mo></mml:mrow></mml:math></alternatives></inline-formula>,
      scale <inline-formula><alternatives><tex-math><![CDATA[(\sigma)]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:mrow><mml:mo stretchy="true" form="prefix">(</mml:mo><mml:mi>σ</mml:mi><mml:mo stretchy="true" form="postfix">)</mml:mo></mml:mrow></mml:math></alternatives></inline-formula>,
      and shape <inline-formula><alternatives><tex-math><![CDATA[(\xi)]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:mrow><mml:mo stretchy="true" form="prefix">(</mml:mo><mml:mi>ξ</mml:mi><mml:mo stretchy="true" form="postfix">)</mml:mo></mml:mrow></mml:math></alternatives></inline-formula>.
      The log-likelihood function for the GEV distribution at a single
      location is:</p>
          <p>
            <disp-formula>
              <alternatives>
                <tex-math><![CDATA[
      \ell(\mu, \sigma, \xi | y) = -n\log\sigma - (1+\frac{1}{\xi})\sum_{i=1}^n \log\left(1+\xi\frac{y_i-\mu}{\sigma}\right) - \sum_{i=1}^n \left(1+\xi\frac{y_i-\mu}{\sigma}\right)^{-1/\xi}
      ]]></tex-math>
                <mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="block">
                  <mml:mrow>
                    <mml:mo>ℓ</mml:mo>
                    <mml:mrow>
                      <mml:mo stretchy="true" form="prefix">(</mml:mo>
                      <mml:mi>μ</mml:mi>
                      <mml:mo>,</mml:mo>
                      <mml:mi>σ</mml:mi>
                      <mml:mo>,</mml:mo>
                      <mml:mi>ξ</mml:mi>
                      <mml:mo stretchy="false" form="prefix">|</mml:mo>
                      <mml:mi>y</mml:mi>
                      <mml:mo stretchy="true" form="postfix">)</mml:mo>
                    </mml:mrow>
                    <mml:mo>=</mml:mo>
                    <mml:mi>−</mml:mi>
                    <mml:mi>n</mml:mi>
                    <mml:mo>log</mml:mo>
                    <mml:mi>σ</mml:mi>
                    <mml:mo>−</mml:mo>
                    <mml:mrow>
                      <mml:mo stretchy="true" form="prefix">(</mml:mo>
                      <mml:mn>1</mml:mn>
                      <mml:mo>+</mml:mo>
                      <mml:mfrac>
                        <mml:mn>1</mml:mn>
                        <mml:mi>ξ</mml:mi>
                      </mml:mfrac>
                      <mml:mo stretchy="true" form="postfix">)</mml:mo>
                    </mml:mrow>
                    <mml:munderover>
                      <mml:mo>∑</mml:mo>
                      <mml:mrow>
                        <mml:mi>i</mml:mi>
                        <mml:mo>=</mml:mo>
                        <mml:mn>1</mml:mn>
                      </mml:mrow>
                      <mml:mi>n</mml:mi>
                    </mml:munderover>
                    <mml:mo>log</mml:mo>
                    <mml:mrow>
                      <mml:mo stretchy="true" form="prefix">(</mml:mo>
                      <mml:mn>1</mml:mn>
                      <mml:mo>+</mml:mo>
                      <mml:mi>ξ</mml:mi>
                      <mml:mfrac>
                        <mml:mrow>
                          <mml:msub>
                            <mml:mi>y</mml:mi>
                            <mml:mi>i</mml:mi>
                          </mml:msub>
                          <mml:mo>−</mml:mo>
                          <mml:mi>μ</mml:mi>
                        </mml:mrow>
                        <mml:mi>σ</mml:mi>
                      </mml:mfrac>
                      <mml:mo stretchy="true" form="postfix">)</mml:mo>
                    </mml:mrow>
                    <mml:mo>−</mml:mo>
                    <mml:munderover>
                      <mml:mo>∑</mml:mo>
                      <mml:mrow>
                        <mml:mi>i</mml:mi>
                        <mml:mo>=</mml:mo>
                        <mml:mn>1</mml:mn>
                      </mml:mrow>
                      <mml:mi>n</mml:mi>
                    </mml:munderover>
                    <mml:msup>
                      <mml:mrow>
                        <mml:mo stretchy="true" form="prefix">(</mml:mo>
                        <mml:mn>1</mml:mn>
                        <mml:mo>+</mml:mo>
                        <mml:mi>ξ</mml:mi>
                        <mml:mfrac>
                          <mml:mrow>
                            <mml:msub>
                              <mml:mi>y</mml:mi>
                              <mml:mi>i</mml:mi>
                            </mml:msub>
                            <mml:mo>−</mml:mo>
                            <mml:mi>μ</mml:mi>
                          </mml:mrow>
                          <mml:mi>σ</mml:mi>
                        </mml:mfrac>
                        <mml:mo stretchy="true" form="postfix">)</mml:mo>
                      </mml:mrow>
                      <mml:mrow>
                        <mml:mi>−</mml:mi>
                        <mml:mn>1</mml:mn>
                        <mml:mi>/</mml:mi>
                        <mml:mi>ξ</mml:mi>
                      </mml:mrow>
                    </mml:msup>
                  </mml:mrow>
                </mml:math>
              </alternatives>
            </disp-formula>
          </p>
          <p>where <inline-formula><alternatives><tex-math><![CDATA[n]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:mi>n</mml:mi></mml:math></alternatives></inline-formula>
      is the number of observations at the location.</p>
          <p>The MLEs are obtained by maximizing this likelihood function
      with respect to the parameters:</p>
          <p>
            <disp-formula>
              <alternatives>
                <tex-math><![CDATA[
      (\hat{\mu}_i, \hat{\sigma}_i, \hat{\xi}_i) = \arg\max_{(\mu, \sigma, \xi)} \ell(\mu, \sigma, \xi | Y_i)
      ]]></tex-math>
                <mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="block">
                  <mml:mrow>
                    <mml:mrow>
                      <mml:mo stretchy="true" form="prefix">(</mml:mo>
                      <mml:msub>
                        <mml:mover>
                          <mml:mi>μ</mml:mi>
                          <mml:mo accent="true">̂</mml:mo>
                        </mml:mover>
                        <mml:mi>i</mml:mi>
                      </mml:msub>
                      <mml:mo>,</mml:mo>
                      <mml:msub>
                        <mml:mover>
                          <mml:mi>σ</mml:mi>
                          <mml:mo accent="true">̂</mml:mo>
                        </mml:mover>
                        <mml:mi>i</mml:mi>
                      </mml:msub>
                      <mml:mo>,</mml:mo>
                      <mml:msub>
                        <mml:mover>
                          <mml:mi>ξ</mml:mi>
                          <mml:mo accent="true">̂</mml:mo>
                        </mml:mover>
                        <mml:mi>i</mml:mi>
                      </mml:msub>
                      <mml:mo stretchy="true" form="postfix">)</mml:mo>
                    </mml:mrow>
                    <mml:mo>=</mml:mo>
                    <mml:mo>arg</mml:mo>
                    <mml:munder>
                      <mml:mo>max</mml:mo>
                      <mml:mrow>
                        <mml:mo stretchy="true" form="prefix">(</mml:mo>
                        <mml:mi>μ</mml:mi>
                        <mml:mo>,</mml:mo>
                        <mml:mi>σ</mml:mi>
                        <mml:mo>,</mml:mo>
                        <mml:mi>ξ</mml:mi>
                        <mml:mo stretchy="true" form="postfix">)</mml:mo>
                      </mml:mrow>
                    </mml:munder>
                    <mml:mo>ℓ</mml:mo>
                    <mml:mrow>
                      <mml:mo stretchy="true" form="prefix">(</mml:mo>
                      <mml:mi>μ</mml:mi>
                      <mml:mo>,</mml:mo>
                      <mml:mi>σ</mml:mi>
                      <mml:mo>,</mml:mo>
                      <mml:mi>ξ</mml:mi>
                      <mml:mo stretchy="false" form="prefix">|</mml:mo>
                      <mml:msub>
                        <mml:mi>Y</mml:mi>
                        <mml:mi>i</mml:mi>
                      </mml:msub>
                      <mml:mo stretchy="true" form="postfix">)</mml:mo>
                    </mml:mrow>
                  </mml:mrow>
                </mml:math>
              </alternatives>
            </disp-formula>
          </p>
          <p>where <inline-formula><alternatives><tex-math><![CDATA[Y_i]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:msub><mml:mi>Y</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:math></alternatives></inline-formula>
      is the data for location <inline-formula><alternatives><tex-math><![CDATA[i]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:mi>i</mml:mi></mml:math></alternatives></inline-formula>.</p>
          <sec id="link-functions">
            <title>Link Functions</title>
            <p>Instead of directly maximizing the likelihood with the
        original parameters, we transform the parameters using a link
        function</p>
            <p>
              <disp-formula>
                <alternatives>
                  <tex-math><![CDATA[
        \left(\psi, \tau, \phi\right) = h(\mu, \sigma, \xi) = \left(\log(\mu), \log(\sigma) - \log(\mu), \text{logit}(\xi)\right)
        ]]></tex-math>
                  <mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="block">
                    <mml:mrow>
                      <mml:mrow>
                        <mml:mo stretchy="true" form="prefix">(</mml:mo>
                        <mml:mi>ψ</mml:mi>
                        <mml:mo>,</mml:mo>
                        <mml:mi>τ</mml:mi>
                        <mml:mo>,</mml:mo>
                        <mml:mi>ϕ</mml:mi>
                        <mml:mo stretchy="true" form="postfix">)</mml:mo>
                      </mml:mrow>
                      <mml:mo>=</mml:mo>
                      <mml:mi>h</mml:mi>
                      <mml:mrow>
                        <mml:mo stretchy="true" form="prefix">(</mml:mo>
                        <mml:mi>μ</mml:mi>
                        <mml:mo>,</mml:mo>
                        <mml:mi>σ</mml:mi>
                        <mml:mo>,</mml:mo>
                        <mml:mi>ξ</mml:mi>
                        <mml:mo stretchy="true" form="postfix">)</mml:mo>
                      </mml:mrow>
                      <mml:mo>=</mml:mo>
                      <mml:mrow>
                        <mml:mo stretchy="true" form="prefix">(</mml:mo>
                        <mml:mo>log</mml:mo>
                        <mml:mrow>
                          <mml:mo stretchy="true" form="prefix">(</mml:mo>
                          <mml:mi>μ</mml:mi>
                          <mml:mo stretchy="true" form="postfix">)</mml:mo>
                        </mml:mrow>
                        <mml:mo>,</mml:mo>
                        <mml:mo>log</mml:mo>
                        <mml:mrow>
                          <mml:mo stretchy="true" form="prefix">(</mml:mo>
                          <mml:mi>σ</mml:mi>
                          <mml:mo stretchy="true" form="postfix">)</mml:mo>
                        </mml:mrow>
                        <mml:mo>−</mml:mo>
                        <mml:mo>log</mml:mo>
                        <mml:mrow>
                          <mml:mo stretchy="true" form="prefix">(</mml:mo>
                          <mml:mi>μ</mml:mi>
                          <mml:mo stretchy="true" form="postfix">)</mml:mo>
                        </mml:mrow>
                        <mml:mo>,</mml:mo>
                        <mml:mtext mathvariant="normal">logit</mml:mtext>
                        <mml:mrow>
                          <mml:mo stretchy="true" form="prefix">(</mml:mo>
                          <mml:mi>ξ</mml:mi>
                          <mml:mo stretchy="true" form="postfix">)</mml:mo>
                        </mml:mrow>
                        <mml:mo stretchy="true" form="postfix">)</mml:mo>
                      </mml:mrow>
                    </mml:mrow>
                  </mml:math>
                </alternatives>
              </disp-formula>
            </p>
          </sec>
        </sec>
        <sec id="implementation">
          <title>Implementation</title>
          <p>The maximization is performed using numerical optimization
      techniques. In our C++ implementation, we use the following
      approach:</p>
          <list list-type="order">
            <list-item>
              <p>Parameters are transformed with a link function</p>
            </list-item>
            <list-item>
              <p>The negative log-likelihood and its gradient are computed
          on the unconstrained scale</p>
            </list-item>
            <list-item>
              <p>A numerical optimizer is used to find the MLEs as well as
          the Hessians at each location’s optimum.</p>
            </list-item>
          </list>
          <p>The output of this step includes:</p>
          <list list-type="order">
            <list-item>
              <p>A vector of parameter estimates,
          <inline-formula><alternatives><tex-math><![CDATA[\hat\eta]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:mover><mml:mi>η</mml:mi><mml:mo accent="true">̂</mml:mo></mml:mover></mml:math></alternatives></inline-formula>,
          ordered such that each station’s location parameter appears
          first, followed by scale parameters, then shape
          parameters:</p>
              <p>
                <disp-formula>
                  <alternatives>
                    <tex-math><![CDATA[
          \hat{\eta} = (\hat{\psi}_1, \ldots, \hat{\psi}_n, \hat{\tau}_1, \ldots, \hat{\tau}_n, \hat{\phi}_1, \ldots, \hat{\phi}_n)^T
          ]]></tex-math>
                    <mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="block">
                      <mml:mrow>
                        <mml:mover>
                          <mml:mi>η</mml:mi>
                          <mml:mo accent="true">̂</mml:mo>
                        </mml:mover>
                        <mml:mo>=</mml:mo>
                        <mml:msup>
                          <mml:mrow>
                            <mml:mo stretchy="true" form="prefix">(</mml:mo>
                            <mml:msub>
                              <mml:mover>
                                <mml:mi>ψ</mml:mi>
                                <mml:mo accent="true">̂</mml:mo>
                              </mml:mover>
                              <mml:mn>1</mml:mn>
                            </mml:msub>
                            <mml:mo>,</mml:mo>
                            <mml:mi>…</mml:mi>
                            <mml:mo>,</mml:mo>
                            <mml:msub>
                              <mml:mover>
                                <mml:mi>ψ</mml:mi>
                                <mml:mo accent="true">̂</mml:mo>
                              </mml:mover>
                              <mml:mi>n</mml:mi>
                            </mml:msub>
                            <mml:mo>,</mml:mo>
                            <mml:msub>
                              <mml:mover>
                                <mml:mi>τ</mml:mi>
                                <mml:mo accent="true">̂</mml:mo>
                              </mml:mover>
                              <mml:mn>1</mml:mn>
                            </mml:msub>
                            <mml:mo>,</mml:mo>
                            <mml:mi>…</mml:mi>
                            <mml:mo>,</mml:mo>
                            <mml:msub>
                              <mml:mover>
                                <mml:mi>τ</mml:mi>
                                <mml:mo accent="true">̂</mml:mo>
                              </mml:mover>
                              <mml:mi>n</mml:mi>
                            </mml:msub>
                            <mml:mo>,</mml:mo>
                            <mml:msub>
                              <mml:mover>
                                <mml:mi>ϕ</mml:mi>
                                <mml:mo accent="true">̂</mml:mo>
                              </mml:mover>
                              <mml:mn>1</mml:mn>
                            </mml:msub>
                            <mml:mo>,</mml:mo>
                            <mml:mi>…</mml:mi>
                            <mml:mo>,</mml:mo>
                            <mml:msub>
                              <mml:mover>
                                <mml:mi>ϕ</mml:mi>
                                <mml:mo accent="true">̂</mml:mo>
                              </mml:mover>
                              <mml:mi>n</mml:mi>
                            </mml:msub>
                            <mml:mo stretchy="true" form="postfix">)</mml:mo>
                          </mml:mrow>
                          <mml:mi>T</mml:mi>
                        </mml:msup>
                      </mml:mrow>
                    </mml:math>
                  </alternatives>
                </disp-formula>
              </p>
              <p>where <inline-formula><alternatives><tex-math><![CDATA[n]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:mi>n</mml:mi></mml:math></alternatives></inline-formula>
          is the number of stations.</p>
            </list-item>
            <list-item>
              <p>A precision matrix, <inline-formula><alternatives><tex-math><![CDATA[Q_{\eta y}]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:msub><mml:mi>Q</mml:mi><mml:mrow><mml:mi>η</mml:mi><mml:mi>y</mml:mi></mml:mrow></mml:msub></mml:math></alternatives></inline-formula>,
          constructed from the negative Hessians of the log-likelihood
          at the MLE estimates. Due to the parameter ordering in
          <inline-formula><alternatives><tex-math><![CDATA[\hat\eta]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:mover><mml:mi>η</mml:mi><mml:mo accent="true">̂</mml:mo></mml:mover></mml:math></alternatives></inline-formula>,
          <inline-formula><alternatives><tex-math><![CDATA[Q_{\eta y}]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:msub><mml:mi>Q</mml:mi><mml:mrow><mml:mi>η</mml:mi><mml:mi>y</mml:mi></mml:mrow></mml:msub></mml:math></alternatives></inline-formula>
          can be described as a 3×3 block matrix:</p>
              <p>
                <disp-formula>
                  <alternatives>
                    <tex-math><![CDATA[
          Q_{\eta y} = \begin{bmatrix}
          Q_{\psi\psi} & Q_{\psi\tau} & Q_{\psi\phi} \\
          Q_{\tau\psi} & Q_{\tau\tau} & Q_{\tau\phi} \\
          Q_{\phi\psi} & Q_{\psi\tau} & Q_{\phi\phi}
          \end{bmatrix}
          ]]></tex-math>
                    <mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="block">
                      <mml:mrow>
                        <mml:msub>
                          <mml:mi>Q</mml:mi>
                          <mml:mrow>
                            <mml:mi>η</mml:mi>
                            <mml:mi>y</mml:mi>
                          </mml:mrow>
                        </mml:msub>
                        <mml:mo>=</mml:mo>
                        <mml:mrow>
                          <mml:mo stretchy="true" form="prefix">[</mml:mo>
                          <mml:mtable>
                            <mml:mtr>
                              <mml:mtd columnalign="center" style="text-align: center">
                                <mml:msub>
                                  <mml:mi>Q</mml:mi>
                                  <mml:mrow>
                                    <mml:mi>ψ</mml:mi>
                                    <mml:mi>ψ</mml:mi>
                                  </mml:mrow>
                                </mml:msub>
                              </mml:mtd>
                              <mml:mtd columnalign="center" style="text-align: center">
                                <mml:msub>
                                  <mml:mi>Q</mml:mi>
                                  <mml:mrow>
                                    <mml:mi>ψ</mml:mi>
                                    <mml:mi>τ</mml:mi>
                                  </mml:mrow>
                                </mml:msub>
                              </mml:mtd>
                              <mml:mtd columnalign="center" style="text-align: center">
                                <mml:msub>
                                  <mml:mi>Q</mml:mi>
                                  <mml:mrow>
                                    <mml:mi>ψ</mml:mi>
                                    <mml:mi>ϕ</mml:mi>
                                  </mml:mrow>
                                </mml:msub>
                              </mml:mtd>
                            </mml:mtr>
                            <mml:mtr>
                              <mml:mtd columnalign="center" style="text-align: center">
                                <mml:msub>
                                  <mml:mi>Q</mml:mi>
                                  <mml:mrow>
                                    <mml:mi>τ</mml:mi>
                                    <mml:mi>ψ</mml:mi>
                                  </mml:mrow>
                                </mml:msub>
                              </mml:mtd>
                              <mml:mtd columnalign="center" style="text-align: center">
                                <mml:msub>
                                  <mml:mi>Q</mml:mi>
                                  <mml:mrow>
                                    <mml:mi>τ</mml:mi>
                                    <mml:mi>τ</mml:mi>
                                  </mml:mrow>
                                </mml:msub>
                              </mml:mtd>
                              <mml:mtd columnalign="center" style="text-align: center">
                                <mml:msub>
                                  <mml:mi>Q</mml:mi>
                                  <mml:mrow>
                                    <mml:mi>τ</mml:mi>
                                    <mml:mi>ϕ</mml:mi>
                                  </mml:mrow>
                                </mml:msub>
                              </mml:mtd>
                            </mml:mtr>
                            <mml:mtr>
                              <mml:mtd columnalign="center" style="text-align: center">
                                <mml:msub>
                                  <mml:mi>Q</mml:mi>
                                  <mml:mrow>
                                    <mml:mi>ϕ</mml:mi>
                                    <mml:mi>ψ</mml:mi>
                                  </mml:mrow>
                                </mml:msub>
                              </mml:mtd>
                              <mml:mtd columnalign="center" style="text-align: center">
                                <mml:msub>
                                  <mml:mi>Q</mml:mi>
                                  <mml:mrow>
                                    <mml:mi>ψ</mml:mi>
                                    <mml:mi>τ</mml:mi>
                                  </mml:mrow>
                                </mml:msub>
                              </mml:mtd>
                              <mml:mtd columnalign="center" style="text-align: center">
                                <mml:msub>
                                  <mml:mi>Q</mml:mi>
                                  <mml:mrow>
                                    <mml:mi>ϕ</mml:mi>
                                    <mml:mi>ϕ</mml:mi>
                                  </mml:mrow>
                                </mml:msub>
                              </mml:mtd>
                            </mml:mtr>
                          </mml:mtable>
                          <mml:mo stretchy="true" form="postfix">]</mml:mo>
                        </mml:mrow>
                      </mml:mrow>
                    </mml:math>
                  </alternatives>
                </disp-formula>
              </p>
              <p>where each block <inline-formula><alternatives><tex-math><![CDATA[Q_{ij}]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:msub><mml:mi>Q</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:math></alternatives></inline-formula>
          is an <inline-formula><alternatives><tex-math><![CDATA[n \times n]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:mrow><mml:mi>n</mml:mi><mml:mo>×</mml:mo><mml:mi>n</mml:mi></mml:mrow></mml:math></alternatives></inline-formula>
          diagonal matrix. The diagonal elements of
          <inline-formula><alternatives><tex-math><![CDATA[Q_{ii}]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:msub><mml:mi>Q</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></alternatives></inline-formula>
          correspond to the negative second derivatives of the
          log-likelihood with respect to the
          <inline-formula><alternatives><tex-math><![CDATA[i]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:mi>i</mml:mi></mml:math></alternatives></inline-formula>-th
          parameter at each station. The off-diagonal blocks
          <inline-formula><alternatives><tex-math><![CDATA[Q_{ij}]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:msub><mml:mi>Q</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:math></alternatives></inline-formula>
          (where <inline-formula><alternatives><tex-math><![CDATA[i \neq j]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:mrow><mml:mi>i</mml:mi><mml:mo>≠</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:math></alternatives></inline-formula>)
          contain the negative mixed partial derivatives of the
          log-likelihood with respect to the
          <inline-formula><alternatives><tex-math><![CDATA[i]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:mi>i</mml:mi></mml:math></alternatives></inline-formula>-th
          and <inline-formula><alternatives><tex-math><![CDATA[j]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:mi>j</mml:mi></mml:math></alternatives></inline-formula>-th
          parameters.</p>
              <p>For example, the elements of <inline-formula><alternatives><tex-math><![CDATA[Q_{\psi\psi}]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:msub><mml:mi>Q</mml:mi><mml:mrow><mml:mi>ψ</mml:mi><mml:mi>ψ</mml:mi></mml:mrow></mml:msub></mml:math></alternatives></inline-formula>
          are the conditional precisions of the location parameters:</p>
              <p>
                <disp-formula>
                  <alternatives>
                    <tex-math><![CDATA[
          \begin{aligned}
          Q_{\psi\psi} &=  \text{diag}\left(\tau^{\psi\psi}_1, \dots, \tau^{\psi\psi}_n\right)\\
          &= \text{diag}\left(-\frac{\partial^2 \ell(Y_1|\psi_1,\tau_1,\phi_1)}{\partial \psi_1^2}, \ldots, -\frac{\partial^2 \ell(Y_n|\psi_n,\tau_n,\phi_n)}{\partial \psi_n^2}\right),
          \end{aligned}
          ]]></tex-math>
                    <mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="block">
                      <mml:mtable>
                        <mml:mtr>
                          <mml:mtd columnalign="right" style="text-align: right">
                            <mml:msub>
                              <mml:mi>Q</mml:mi>
                              <mml:mrow>
                                <mml:mi>ψ</mml:mi>
                                <mml:mi>ψ</mml:mi>
                              </mml:mrow>
                            </mml:msub>
                          </mml:mtd>
                          <mml:mtd columnalign="left" style="text-align: left">
                            <mml:mo>=</mml:mo>
                            <mml:mtext mathvariant="normal">diag</mml:mtext>
                            <mml:mrow>
                              <mml:mo stretchy="true" form="prefix">(</mml:mo>
                              <mml:msubsup>
                                <mml:mi>τ</mml:mi>
                                <mml:mn>1</mml:mn>
                                <mml:mrow>
                                  <mml:mi>ψ</mml:mi>
                                  <mml:mi>ψ</mml:mi>
                                </mml:mrow>
                              </mml:msubsup>
                              <mml:mo>,</mml:mo>
                              <mml:mi>…</mml:mi>
                              <mml:mo>,</mml:mo>
                              <mml:msubsup>
                                <mml:mi>τ</mml:mi>
                                <mml:mi>n</mml:mi>
                                <mml:mrow>
                                  <mml:mi>ψ</mml:mi>
                                  <mml:mi>ψ</mml:mi>
                                </mml:mrow>
                              </mml:msubsup>
                              <mml:mo stretchy="true" form="postfix">)</mml:mo>
                            </mml:mrow>
                          </mml:mtd>
                        </mml:mtr>
                        <mml:mtr>
                          <mml:mtd columnalign="right" style="text-align: right"/>
                          <mml:mtd columnalign="left" style="text-align: left">
                            <mml:mo>=</mml:mo>
                            <mml:mtext mathvariant="normal">diag</mml:mtext>
                            <mml:mrow>
                              <mml:mo stretchy="true" form="prefix">(</mml:mo>
                              <mml:mi>−</mml:mi>
                              <mml:mfrac>
                                <mml:mrow>
                                  <mml:msup>
                                    <mml:mi>∂</mml:mi>
                                    <mml:mn>2</mml:mn>
                                  </mml:msup>
                                  <mml:mo>ℓ</mml:mo>
                                  <mml:mrow>
                                    <mml:mo stretchy="true" form="prefix">(</mml:mo>
                                    <mml:msub>
                                      <mml:mi>Y</mml:mi>
                                      <mml:mn>1</mml:mn>
                                    </mml:msub>
                                    <mml:mo stretchy="false" form="prefix">|</mml:mo>
                                    <mml:msub>
                                      <mml:mi>ψ</mml:mi>
                                      <mml:mn>1</mml:mn>
                                    </mml:msub>
                                    <mml:mo>,</mml:mo>
                                    <mml:msub>
                                      <mml:mi>τ</mml:mi>
                                      <mml:mn>1</mml:mn>
                                    </mml:msub>
                                    <mml:mo>,</mml:mo>
                                    <mml:msub>
                                      <mml:mi>ϕ</mml:mi>
                                      <mml:mn>1</mml:mn>
                                    </mml:msub>
                                    <mml:mo stretchy="true" form="postfix">)</mml:mo>
                                  </mml:mrow>
                                </mml:mrow>
                                <mml:mrow>
                                  <mml:mi>∂</mml:mi>
                                  <mml:msubsup>
                                    <mml:mi>ψ</mml:mi>
                                    <mml:mn>1</mml:mn>
                                    <mml:mn>2</mml:mn>
                                  </mml:msubsup>
                                </mml:mrow>
                              </mml:mfrac>
                              <mml:mo>,</mml:mo>
                              <mml:mi>…</mml:mi>
                              <mml:mo>,</mml:mo>
                              <mml:mi>−</mml:mi>
                              <mml:mfrac>
                                <mml:mrow>
                                  <mml:msup>
                                    <mml:mi>∂</mml:mi>
                                    <mml:mn>2</mml:mn>
                                  </mml:msup>
                                  <mml:mo>ℓ</mml:mo>
                                  <mml:mrow>
                                    <mml:mo stretchy="true" form="prefix">(</mml:mo>
                                    <mml:msub>
                                      <mml:mi>Y</mml:mi>
                                      <mml:mi>n</mml:mi>
                                    </mml:msub>
                                    <mml:mo stretchy="false" form="prefix">|</mml:mo>
                                    <mml:msub>
                                      <mml:mi>ψ</mml:mi>
                                      <mml:mi>n</mml:mi>
                                    </mml:msub>
                                    <mml:mo>,</mml:mo>
                                    <mml:msub>
                                      <mml:mi>τ</mml:mi>
                                      <mml:mi>n</mml:mi>
                                    </mml:msub>
                                    <mml:mo>,</mml:mo>
                                    <mml:msub>
                                      <mml:mi>ϕ</mml:mi>
                                      <mml:mi>n</mml:mi>
                                    </mml:msub>
                                    <mml:mo stretchy="true" form="postfix">)</mml:mo>
                                  </mml:mrow>
                                </mml:mrow>
                                <mml:mrow>
                                  <mml:mi>∂</mml:mi>
                                  <mml:msubsup>
                                    <mml:mi>ψ</mml:mi>
                                    <mml:mi>n</mml:mi>
                                    <mml:mn>2</mml:mn>
                                  </mml:msubsup>
                                </mml:mrow>
                              </mml:mfrac>
                              <mml:mo stretchy="true" form="postfix">)</mml:mo>
                            </mml:mrow>
                            <mml:mo>,</mml:mo>
                          </mml:mtd>
                        </mml:mtr>
                      </mml:mtable>
                    </mml:math>
                  </alternatives>
                </disp-formula>
              </p>
              <p>and the elements of <inline-formula><alternatives><tex-math><![CDATA[Q_{\mu\xi}]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:msub><mml:mi>Q</mml:mi><mml:mrow><mml:mi>μ</mml:mi><mml:mi>ξ</mml:mi></mml:mrow></mml:msub></mml:math></alternatives></inline-formula>
          are the conditional dependencies between the location and
          shape parameters:</p>
              <p>
                <disp-formula>
                  <alternatives>
                    <tex-math><![CDATA[
          \begin{aligned}
          Q_{\psi\phi} &= \text{diag}\left(\tau^{\psi\phi}_1, \dots, \tau^{\psi\phi}_n\right) \\
          &= \text{diag}\left(-\frac{\partial^2 \ell(Y_1|\psi_1,\tau_1,\phi_1)}{\partial \psi_1\partial \phi_1}, \ldots, -\frac{\partial^2 \ell(Y_n|\psi_n,\tau_n,\phi_n)}{\partial \psi_n\partial \phi_n}\right)
          \end{aligned}
          ]]></tex-math>
                    <mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="block">
                      <mml:mtable>
                        <mml:mtr>
                          <mml:mtd columnalign="right" style="text-align: right">
                            <mml:msub>
                              <mml:mi>Q</mml:mi>
                              <mml:mrow>
                                <mml:mi>ψ</mml:mi>
                                <mml:mi>ϕ</mml:mi>
                              </mml:mrow>
                            </mml:msub>
                          </mml:mtd>
                          <mml:mtd columnalign="left" style="text-align: left">
                            <mml:mo>=</mml:mo>
                            <mml:mtext mathvariant="normal">diag</mml:mtext>
                            <mml:mrow>
                              <mml:mo stretchy="true" form="prefix">(</mml:mo>
                              <mml:msubsup>
                                <mml:mi>τ</mml:mi>
                                <mml:mn>1</mml:mn>
                                <mml:mrow>
                                  <mml:mi>ψ</mml:mi>
                                  <mml:mi>ϕ</mml:mi>
                                </mml:mrow>
                              </mml:msubsup>
                              <mml:mo>,</mml:mo>
                              <mml:mi>…</mml:mi>
                              <mml:mo>,</mml:mo>
                              <mml:msubsup>
                                <mml:mi>τ</mml:mi>
                                <mml:mi>n</mml:mi>
                                <mml:mrow>
                                  <mml:mi>ψ</mml:mi>
                                  <mml:mi>ϕ</mml:mi>
                                </mml:mrow>
                              </mml:msubsup>
                              <mml:mo stretchy="true" form="postfix">)</mml:mo>
                            </mml:mrow>
                          </mml:mtd>
                        </mml:mtr>
                        <mml:mtr>
                          <mml:mtd columnalign="right" style="text-align: right"/>
                          <mml:mtd columnalign="left" style="text-align: left">
                            <mml:mo>=</mml:mo>
                            <mml:mtext mathvariant="normal">diag</mml:mtext>
                            <mml:mrow>
                              <mml:mo stretchy="true" form="prefix">(</mml:mo>
                              <mml:mi>−</mml:mi>
                              <mml:mfrac>
                                <mml:mrow>
                                  <mml:msup>
                                    <mml:mi>∂</mml:mi>
                                    <mml:mn>2</mml:mn>
                                  </mml:msup>
                                  <mml:mo>ℓ</mml:mo>
                                  <mml:mrow>
                                    <mml:mo stretchy="true" form="prefix">(</mml:mo>
                                    <mml:msub>
                                      <mml:mi>Y</mml:mi>
                                      <mml:mn>1</mml:mn>
                                    </mml:msub>
                                    <mml:mo stretchy="false" form="prefix">|</mml:mo>
                                    <mml:msub>
                                      <mml:mi>ψ</mml:mi>
                                      <mml:mn>1</mml:mn>
                                    </mml:msub>
                                    <mml:mo>,</mml:mo>
                                    <mml:msub>
                                      <mml:mi>τ</mml:mi>
                                      <mml:mn>1</mml:mn>
                                    </mml:msub>
                                    <mml:mo>,</mml:mo>
                                    <mml:msub>
                                      <mml:mi>ϕ</mml:mi>
                                      <mml:mn>1</mml:mn>
                                    </mml:msub>
                                    <mml:mo stretchy="true" form="postfix">)</mml:mo>
                                  </mml:mrow>
                                </mml:mrow>
                                <mml:mrow>
                                  <mml:mi>∂</mml:mi>
                                  <mml:msub>
                                    <mml:mi>ψ</mml:mi>
                                    <mml:mn>1</mml:mn>
                                  </mml:msub>
                                  <mml:mi>∂</mml:mi>
                                  <mml:msub>
                                    <mml:mi>ϕ</mml:mi>
                                    <mml:mn>1</mml:mn>
                                  </mml:msub>
                                </mml:mrow>
                              </mml:mfrac>
                              <mml:mo>,</mml:mo>
                              <mml:mi>…</mml:mi>
                              <mml:mo>,</mml:mo>
                              <mml:mi>−</mml:mi>
                              <mml:mfrac>
                                <mml:mrow>
                                  <mml:msup>
                                    <mml:mi>∂</mml:mi>
                                    <mml:mn>2</mml:mn>
                                  </mml:msup>
                                  <mml:mo>ℓ</mml:mo>
                                  <mml:mrow>
                                    <mml:mo stretchy="true" form="prefix">(</mml:mo>
                                    <mml:msub>
                                      <mml:mi>Y</mml:mi>
                                      <mml:mi>n</mml:mi>
                                    </mml:msub>
                                    <mml:mo stretchy="false" form="prefix">|</mml:mo>
                                    <mml:msub>
                                      <mml:mi>ψ</mml:mi>
                                      <mml:mi>n</mml:mi>
                                    </mml:msub>
                                    <mml:mo>,</mml:mo>
                                    <mml:msub>
                                      <mml:mi>τ</mml:mi>
                                      <mml:mi>n</mml:mi>
                                    </mml:msub>
                                    <mml:mo>,</mml:mo>
                                    <mml:msub>
                                      <mml:mi>ϕ</mml:mi>
                                      <mml:mi>n</mml:mi>
                                    </mml:msub>
                                    <mml:mo stretchy="true" form="postfix">)</mml:mo>
                                  </mml:mrow>
                                </mml:mrow>
                                <mml:mrow>
                                  <mml:mi>∂</mml:mi>
                                  <mml:msub>
                                    <mml:mi>ψ</mml:mi>
                                    <mml:mi>n</mml:mi>
                                  </mml:msub>
                                  <mml:mi>∂</mml:mi>
                                  <mml:msub>
                                    <mml:mi>ϕ</mml:mi>
                                    <mml:mi>n</mml:mi>
                                  </mml:msub>
                                </mml:mrow>
                              </mml:mfrac>
                              <mml:mo stretchy="true" form="postfix">)</mml:mo>
                            </mml:mrow>
                          </mml:mtd>
                        </mml:mtr>
                      </mml:mtable>
                    </mml:math>
                  </alternatives>
                </disp-formula>
              </p>
            </list-item>
          </list>
          <p>This structure reflects the independence assumption between
      stations in the Max step, while capturing the parameter
      dependencies within each station. The outputs,
      <inline-formula><alternatives><tex-math><![CDATA[\hat \eta]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:mover><mml:mi>η</mml:mi><mml:mo accent="true">̂</mml:mo></mml:mover></mml:math></alternatives></inline-formula>
      and <inline-formula><alternatives><tex-math><![CDATA[Q_{\eta y}]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:msub><mml:mi>Q</mml:mi><mml:mrow><mml:mi>η</mml:mi><mml:mi>y</mml:mi></mml:mrow></mml:msub></mml:math></alternatives></inline-formula>,
      serve as inputs into the Smooth step.</p>
        </sec>
      </sec>
      <sec id="smooth-step">
        <title>Smooth Step</title>
        <p>The Smooth step involves Bayesian inference on a latent Gaussian
    field, using the maximum likelihood estimates from the Max step as
    data.</p>
        <sec id="model-structure">
          <title>Model Structure</title>
          <p>Let <inline-formula><alternatives><tex-math><![CDATA[\eta]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:mi>η</mml:mi></mml:math></alternatives></inline-formula>
      be the latent field of parameters, and
      <inline-formula><alternatives><tex-math><![CDATA[\hat{\eta}]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:mover><mml:mi>η</mml:mi><mml:mo accent="true">̂</mml:mo></mml:mover></mml:math></alternatives></inline-formula>
      be the maximum likelihood estimates from the Max step. The model
      is structured as follows:</p>
          <list list-type="order">
            <list-item>
              <p>Data level: <inline-formula><alternatives><tex-math><![CDATA[\hat{\eta} | \eta \sim N(\eta, Q_{\eta y}^{-1})]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:mrow><mml:mover><mml:mi>η</mml:mi><mml:mo accent="true">̂</mml:mo></mml:mover><mml:mo stretchy="false" form="prefix">|</mml:mo><mml:mi>η</mml:mi><mml:mo>∼</mml:mo><mml:mi>N</mml:mi><mml:mrow><mml:mo stretchy="true" form="prefix">(</mml:mo><mml:mi>η</mml:mi><mml:mo>,</mml:mo><mml:msubsup><mml:mi>Q</mml:mi><mml:mrow><mml:mi>η</mml:mi><mml:mi>y</mml:mi></mml:mrow><mml:mrow><mml:mi>−</mml:mi><mml:mn>1</mml:mn></mml:mrow></mml:msubsup><mml:mo stretchy="true" form="postfix">)</mml:mo></mml:mrow></mml:mrow></mml:math></alternatives></inline-formula></p>
            </list-item>
            <list-item>
              <p>Latent level: <inline-formula><alternatives><tex-math><![CDATA[\eta | \tau_\eta \sim N(0, Q_\eta^{-1})]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:mrow><mml:mi>η</mml:mi><mml:mo stretchy="false" form="prefix">|</mml:mo><mml:msub><mml:mi>τ</mml:mi><mml:mi>η</mml:mi></mml:msub><mml:mo>∼</mml:mo><mml:mi>N</mml:mi><mml:mrow><mml:mo stretchy="true" form="prefix">(</mml:mo><mml:mn>0</mml:mn><mml:mo>,</mml:mo><mml:msubsup><mml:mi>Q</mml:mi><mml:mi>η</mml:mi><mml:mrow><mml:mi>−</mml:mi><mml:mn>1</mml:mn></mml:mrow></mml:msubsup><mml:mo stretchy="true" form="postfix">)</mml:mo></mml:mrow></mml:mrow></mml:math></alternatives></inline-formula></p>
            </list-item>
            <list-item>
              <p>Hyperparameter level: <inline-formula><alternatives><tex-math><![CDATA[\tau_\eta \sim \pi(\tau_\eta)]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:mrow><mml:msub><mml:mi>τ</mml:mi><mml:mi>η</mml:mi></mml:msub><mml:mo>∼</mml:mo><mml:mi>π</mml:mi><mml:mrow><mml:mo stretchy="true" form="prefix">(</mml:mo><mml:msub><mml:mi>τ</mml:mi><mml:mi>η</mml:mi></mml:msub><mml:mo stretchy="true" form="postfix">)</mml:mo></mml:mrow></mml:mrow></mml:math></alternatives></inline-formula></p>
            </list-item>
          </list>
          <p>where <inline-formula><alternatives><tex-math><![CDATA[Q_{\eta y}]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:msub><mml:mi>Q</mml:mi><mml:mrow><mml:mi>η</mml:mi><mml:mi>y</mml:mi></mml:mrow></mml:msub></mml:math></alternatives></inline-formula>
      is the precision matrix from the Max step, and
      <inline-formula><alternatives><tex-math><![CDATA[Q_\eta]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:msub><mml:mi>Q</mml:mi><mml:mi>η</mml:mi></mml:msub></mml:math></alternatives></inline-formula>
      is the precision matrix of the latent field, parameterized by
      hyperparameters <inline-formula><alternatives><tex-math><![CDATA[\tau_\eta]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:msub><mml:mi>τ</mml:mi><mml:mi>η</mml:mi></mml:msub></mml:math></alternatives></inline-formula>.</p>
          <sec id="data-level">
            <title>Data Level</title>
            <p>The data level models the relationship between the observed
        maximum likelihood estimates <inline-formula><alternatives><tex-math><![CDATA[\hat{\eta}]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:mover><mml:mi>η</mml:mi><mml:mo accent="true">̂</mml:mo></mml:mover></mml:math></alternatives></inline-formula>
        and the true latent field <inline-formula><alternatives><tex-math><![CDATA[\eta]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:mi>η</mml:mi></mml:math></alternatives></inline-formula>:</p>
            <p>
              <disp-formula>
                <alternatives>
                  <tex-math><![CDATA[\hat{\eta} | \eta \sim N(\eta, Q_{\eta y}^{-1})]]></tex-math>
                  <mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="block">
                    <mml:mrow>
                      <mml:mover>
                        <mml:mi>η</mml:mi>
                        <mml:mo accent="true">̂</mml:mo>
                      </mml:mover>
                      <mml:mo stretchy="false" form="prefix">|</mml:mo>
                      <mml:mi>η</mml:mi>
                      <mml:mo>∼</mml:mo>
                      <mml:mi>N</mml:mi>
                      <mml:mrow>
                        <mml:mo stretchy="true" form="prefix">(</mml:mo>
                        <mml:mi>η</mml:mi>
                        <mml:mo>,</mml:mo>
                        <mml:msubsup>
                          <mml:mi>Q</mml:mi>
                          <mml:mrow>
                            <mml:mi>η</mml:mi>
                            <mml:mi>y</mml:mi>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:mi>−</mml:mi>
                            <mml:mn>1</mml:mn>
                          </mml:mrow>
                        </mml:msubsup>
                        <mml:mo stretchy="true" form="postfix">)</mml:mo>
                      </mml:mrow>
                    </mml:mrow>
                  </mml:math>
                </alternatives>
              </disp-formula>
            </p>
            <p>Here, <inline-formula><alternatives><tex-math><![CDATA[Q_{\eta y}]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:msub><mml:mi>Q</mml:mi><mml:mrow><mml:mi>η</mml:mi><mml:mi>y</mml:mi></mml:mrow></mml:msub></mml:math></alternatives></inline-formula>
        is the precision matrix obtained from the Max step, representing
        the uncertainty in the MLE estimates. This can be thought of as
        using the outputs of the Max step as sufficient statistics for
        the observed data.</p>
          </sec>
          <sec id="latent-level">
            <title>Latent Level</title>
            <p>The latent level models the spatial structure of the
        parameter field: <disp-formula><alternatives><tex-math><![CDATA[
        \eta | \tau_\eta \sim N(0, Q_\eta^{-1})
        ]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="block"><mml:mrow><mml:mi>η</mml:mi><mml:mo stretchy="false" form="prefix">|</mml:mo><mml:msub><mml:mi>τ</mml:mi><mml:mi>η</mml:mi></mml:msub><mml:mo>∼</mml:mo><mml:mi>N</mml:mi><mml:mrow><mml:mo stretchy="true" form="prefix">(</mml:mo><mml:mn>0</mml:mn><mml:mo>,</mml:mo><mml:msubsup><mml:mi>Q</mml:mi><mml:mi>η</mml:mi><mml:mrow><mml:mi>−</mml:mi><mml:mn>1</mml:mn></mml:mrow></mml:msubsup><mml:mo stretchy="true" form="postfix">)</mml:mo></mml:mrow></mml:mrow></mml:math></alternatives></disp-formula></p>
            <p>Here, <inline-formula><alternatives><tex-math><![CDATA[Q_\eta]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:msub><mml:mi>Q</mml:mi><mml:mi>η</mml:mi></mml:msub></mml:math></alternatives></inline-formula>
        is a block diagonal precision matrix that encodes the spatial
        dependence structure of the latent field. The block diagonal
        structure reflects the assumption of independence between
        different parameters, while allowing for spatial correlation
        within each parameter field. The precision matrix
        <inline-formula><alternatives><tex-math><![CDATA[Q_\eta]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:msub><mml:mi>Q</mml:mi><mml:mi>η</mml:mi></mml:msub></mml:math></alternatives></inline-formula>
        is constructed as follows:</p>
            <p>
              <disp-formula>
                <alternatives>
                  <tex-math><![CDATA[
        Q_\eta = \begin{bmatrix}
        \tau_\psi Q_{\text{prior}} & 0 & 0 \\
        0 & \tau_\tau Q_{\text{prior}} & 0 \\
        0 & 0 & \tau_\phi Q_{\text{prior}}
        \end{bmatrix}
        ]]></tex-math>
                  <mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="block">
                    <mml:mrow>
                      <mml:msub>
                        <mml:mi>Q</mml:mi>
                        <mml:mi>η</mml:mi>
                      </mml:msub>
                      <mml:mo>=</mml:mo>
                      <mml:mrow>
                        <mml:mo stretchy="true" form="prefix">[</mml:mo>
                        <mml:mtable>
                          <mml:mtr>
                            <mml:mtd columnalign="center" style="text-align: center">
                              <mml:msub>
                                <mml:mi>τ</mml:mi>
                                <mml:mi>ψ</mml:mi>
                              </mml:msub>
                              <mml:msub>
                                <mml:mi>Q</mml:mi>
                                <mml:mtext mathvariant="normal">prior</mml:mtext>
                              </mml:msub>
                            </mml:mtd>
                            <mml:mtd columnalign="center" style="text-align: center">
                              <mml:mn>0</mml:mn>
                            </mml:mtd>
                            <mml:mtd columnalign="center" style="text-align: center">
                              <mml:mn>0</mml:mn>
                            </mml:mtd>
                          </mml:mtr>
                          <mml:mtr>
                            <mml:mtd columnalign="center" style="text-align: center">
                              <mml:mn>0</mml:mn>
                            </mml:mtd>
                            <mml:mtd columnalign="center" style="text-align: center">
                              <mml:msub>
                                <mml:mi>τ</mml:mi>
                                <mml:mi>τ</mml:mi>
                              </mml:msub>
                              <mml:msub>
                                <mml:mi>Q</mml:mi>
                                <mml:mtext mathvariant="normal">prior</mml:mtext>
                              </mml:msub>
                            </mml:mtd>
                            <mml:mtd columnalign="center" style="text-align: center">
                              <mml:mn>0</mml:mn>
                            </mml:mtd>
                          </mml:mtr>
                          <mml:mtr>
                            <mml:mtd columnalign="center" style="text-align: center">
                              <mml:mn>0</mml:mn>
                            </mml:mtd>
                            <mml:mtd columnalign="center" style="text-align: center">
                              <mml:mn>0</mml:mn>
                            </mml:mtd>
                            <mml:mtd columnalign="center" style="text-align: center">
                              <mml:msub>
                                <mml:mi>τ</mml:mi>
                                <mml:mi>ϕ</mml:mi>
                              </mml:msub>
                              <mml:msub>
                                <mml:mi>Q</mml:mi>
                                <mml:mtext mathvariant="normal">prior</mml:mtext>
                              </mml:msub>
                            </mml:mtd>
                          </mml:mtr>
                        </mml:mtable>
                        <mml:mo stretchy="true" form="postfix">]</mml:mo>
                      </mml:mrow>
                    </mml:mrow>
                  </mml:math>
                </alternatives>
              </disp-formula>
            </p>
            <p>where</p>
            <p>
              <disp-formula>
                <alternatives>
                  <tex-math><![CDATA[
        Q_{\text{prior}} = \begin{bmatrix}
        2 & -1 \\
        -1 & 2 & -1 \\
        & -1 & 2 & -1 \\
        & & \vdots & \vdots & \vdots \\
        & & & -1 & 2 & -1 \\
        & & & & -1 & 2 & -1 \\
        & & & & & -1 & 2
        \end{bmatrix}
        ]]></tex-math>
                  <mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="block">
                    <mml:mrow>
                      <mml:msub>
                        <mml:mi>Q</mml:mi>
                        <mml:mtext mathvariant="normal">prior</mml:mtext>
                      </mml:msub>
                      <mml:mo>=</mml:mo>
                      <mml:mrow>
                        <mml:mo stretchy="true" form="prefix">[</mml:mo>
                        <mml:mtable>
                          <mml:mtr>
                            <mml:mtd columnalign="center" style="text-align: center">
                              <mml:mn>2</mml:mn>
                            </mml:mtd>
                            <mml:mtd columnalign="center" style="text-align: center">
                              <mml:mi>−</mml:mi>
                              <mml:mn>1</mml:mn>
                            </mml:mtd>
                          </mml:mtr>
                          <mml:mtr>
                            <mml:mtd columnalign="center" style="text-align: center">
                              <mml:mi>−</mml:mi>
                              <mml:mn>1</mml:mn>
                            </mml:mtd>
                            <mml:mtd columnalign="center" style="text-align: center">
                              <mml:mn>2</mml:mn>
                            </mml:mtd>
                            <mml:mtd columnalign="center" style="text-align: center">
                              <mml:mi>−</mml:mi>
                              <mml:mn>1</mml:mn>
                            </mml:mtd>
                          </mml:mtr>
                          <mml:mtr>
                            <mml:mtd columnalign="center" style="text-align: center"/>
                            <mml:mtd columnalign="center" style="text-align: center">
                              <mml:mi>−</mml:mi>
                              <mml:mn>1</mml:mn>
                            </mml:mtd>
                            <mml:mtd columnalign="center" style="text-align: center">
                              <mml:mn>2</mml:mn>
                            </mml:mtd>
                            <mml:mtd columnalign="center" style="text-align: center">
                              <mml:mi>−</mml:mi>
                              <mml:mn>1</mml:mn>
                            </mml:mtd>
                          </mml:mtr>
                          <mml:mtr>
                            <mml:mtd columnalign="center" style="text-align: center"/>
                            <mml:mtd columnalign="center" style="text-align: center"/>
                            <mml:mtd columnalign="center" style="text-align: center">
                              <mml:mi>⋮</mml:mi>
                            </mml:mtd>
                            <mml:mtd columnalign="center" style="text-align: center">
                              <mml:mi>⋮</mml:mi>
                            </mml:mtd>
                            <mml:mtd columnalign="center" style="text-align: center">
                              <mml:mi>⋮</mml:mi>
                            </mml:mtd>
                          </mml:mtr>
                          <mml:mtr>
                            <mml:mtd columnalign="center" style="text-align: center"/>
                            <mml:mtd columnalign="center" style="text-align: center"/>
                            <mml:mtd columnalign="center" style="text-align: center"/>
                            <mml:mtd columnalign="center" style="text-align: center">
                              <mml:mi>−</mml:mi>
                              <mml:mn>1</mml:mn>
                            </mml:mtd>
                            <mml:mtd columnalign="center" style="text-align: center">
                              <mml:mn>2</mml:mn>
                            </mml:mtd>
                            <mml:mtd columnalign="center" style="text-align: center">
                              <mml:mi>−</mml:mi>
                              <mml:mn>1</mml:mn>
                            </mml:mtd>
                          </mml:mtr>
                          <mml:mtr>
                            <mml:mtd columnalign="center" style="text-align: center"/>
                            <mml:mtd columnalign="center" style="text-align: center"/>
                            <mml:mtd columnalign="center" style="text-align: center"/>
                            <mml:mtd columnalign="center" style="text-align: center"/>
                            <mml:mtd columnalign="center" style="text-align: center">
                              <mml:mi>−</mml:mi>
                              <mml:mn>1</mml:mn>
                            </mml:mtd>
                            <mml:mtd columnalign="center" style="text-align: center">
                              <mml:mn>2</mml:mn>
                            </mml:mtd>
                            <mml:mtd columnalign="center" style="text-align: center">
                              <mml:mi>−</mml:mi>
                              <mml:mn>1</mml:mn>
                            </mml:mtd>
                          </mml:mtr>
                          <mml:mtr>
                            <mml:mtd columnalign="center" style="text-align: center"/>
                            <mml:mtd columnalign="center" style="text-align: center"/>
                            <mml:mtd columnalign="center" style="text-align: center"/>
                            <mml:mtd columnalign="center" style="text-align: center"/>
                            <mml:mtd columnalign="center" style="text-align: center"/>
                            <mml:mtd columnalign="center" style="text-align: center">
                              <mml:mi>−</mml:mi>
                              <mml:mn>1</mml:mn>
                            </mml:mtd>
                            <mml:mtd columnalign="center" style="text-align: center">
                              <mml:mn>2</mml:mn>
                            </mml:mtd>
                          </mml:mtr>
                        </mml:mtable>
                        <mml:mo stretchy="true" form="postfix">]</mml:mo>
                      </mml:mrow>
                    </mml:mrow>
                  </mml:math>
                </alternatives>
              </disp-formula>
            </p>
            <p>and <inline-formula><alternatives><tex-math><![CDATA[\tau_\eta = \left(\tau_\psi, \tau_\tau, \tau_\phi\right)^T]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:mrow><mml:msub><mml:mi>τ</mml:mi><mml:mi>η</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:msup><mml:mrow><mml:mo stretchy="true" form="prefix">(</mml:mo><mml:msub><mml:mi>τ</mml:mi><mml:mi>ψ</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>τ</mml:mi><mml:mi>τ</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>τ</mml:mi><mml:mi>ϕ</mml:mi></mml:msub><mml:mo stretchy="true" form="postfix">)</mml:mo></mml:mrow><mml:mi>T</mml:mi></mml:msup></mml:mrow></mml:math></alternatives></inline-formula>
        are the hyperparameters controlling the strength of spatial
        dependence for each parameter.</p>
          </sec>
          <sec id="hyperparameter-level">
            <title>Hyperparameter Level</title>
            <p>The hyperparameters <inline-formula><alternatives><tex-math><![CDATA[\tau_\eta]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:msub><mml:mi>τ</mml:mi><mml:mi>η</mml:mi></mml:msub></mml:math></alternatives></inline-formula>
        are assigned prior distributions.</p>
          </sec>
        </sec>
        <sec id="posterior-distribution">
          <title>Posterior Distribution</title>
          <p>The posterior distribution of interest is:</p>
          <p>
            <disp-formula>
              <alternatives>
                <tex-math><![CDATA[
      p(\eta, \tau | \hat{\eta}) \propto p(\hat{\eta} | \eta) p(\eta | \tau_\eta) p(\tau_\eta)
      ]]></tex-math>
                <mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="block">
                  <mml:mrow>
                    <mml:mi>p</mml:mi>
                    <mml:mrow>
                      <mml:mo stretchy="true" form="prefix">(</mml:mo>
                      <mml:mi>η</mml:mi>
                      <mml:mo>,</mml:mo>
                      <mml:mi>τ</mml:mi>
                      <mml:mo stretchy="false" form="prefix">|</mml:mo>
                      <mml:mover>
                        <mml:mi>η</mml:mi>
                        <mml:mo accent="true">̂</mml:mo>
                      </mml:mover>
                      <mml:mo stretchy="true" form="postfix">)</mml:mo>
                    </mml:mrow>
                    <mml:mo>∝</mml:mo>
                    <mml:mi>p</mml:mi>
                    <mml:mrow>
                      <mml:mo stretchy="true" form="prefix">(</mml:mo>
                      <mml:mover>
                        <mml:mi>η</mml:mi>
                        <mml:mo accent="true">̂</mml:mo>
                      </mml:mover>
                      <mml:mo stretchy="false" form="prefix">|</mml:mo>
                      <mml:mi>η</mml:mi>
                      <mml:mo stretchy="true" form="postfix">)</mml:mo>
                    </mml:mrow>
                    <mml:mi>p</mml:mi>
                    <mml:mrow>
                      <mml:mo stretchy="true" form="prefix">(</mml:mo>
                      <mml:mi>η</mml:mi>
                      <mml:mo stretchy="false" form="prefix">|</mml:mo>
                      <mml:msub>
                        <mml:mi>τ</mml:mi>
                        <mml:mi>η</mml:mi>
                      </mml:msub>
                      <mml:mo stretchy="true" form="postfix">)</mml:mo>
                    </mml:mrow>
                    <mml:mi>p</mml:mi>
                    <mml:mrow>
                      <mml:mo stretchy="true" form="prefix">(</mml:mo>
                      <mml:msub>
                        <mml:mi>τ</mml:mi>
                        <mml:mi>η</mml:mi>
                      </mml:msub>
                      <mml:mo stretchy="true" form="postfix">)</mml:mo>
                    </mml:mrow>
                  </mml:mrow>
                </mml:math>
              </alternatives>
            </disp-formula>
          </p>
        </sec>
        <sec id="mcmc-sampling">
          <title>MCMC Sampling</title>
          <p>The Smooth step uses Metropolis-Hastings MCMC to sample from
      this posterior. The algorithm alternates between:</p>
          <list list-type="order">
            <list-item>
              <p>Proposing new hyperparameters
          <inline-formula><alternatives><tex-math><![CDATA[\tau_\eta^*]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:msubsup><mml:mi>τ</mml:mi><mml:mi>η</mml:mi><mml:mo>*</mml:mo></mml:msubsup></mml:math></alternatives></inline-formula></p>
            </list-item>
            <list-item>
              <p>Sampling a new latent field <inline-formula><alternatives><tex-math><![CDATA[\eta^*]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:msup><mml:mi>η</mml:mi><mml:mo>*</mml:mo></mml:msup></mml:math></alternatives></inline-formula>
          conditional on <inline-formula><alternatives><tex-math><![CDATA[\tau_\eta^*]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:msubsup><mml:mi>τ</mml:mi><mml:mi>η</mml:mi><mml:mo>*</mml:mo></mml:msubsup></mml:math></alternatives></inline-formula></p>
            </list-item>
            <list-item>
              <p>Accepting or rejecting the proposal based on the
          Metropolis-Hastings ratio</p>
            </list-item>
          </list>
          <sec id="latent-field-sampling">
            <title>Latent Field Sampling</title>
            <p>The latent field is sampled from the conditional normal
        distribution</p>
            <p>
              <disp-formula>
                <alternatives>
                  <tex-math><![CDATA[
        \eta \vert \hat\eta, \tau_\eta \sim \mathrm{N}(\mu_{\text{post}}, Q_{\text{post}}),
        ]]></tex-math>
                  <mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="block">
                    <mml:mrow>
                      <mml:mi>η</mml:mi>
                      <mml:mo stretchy="false" form="postfix">|</mml:mo>
                      <mml:mover>
                        <mml:mi>η</mml:mi>
                        <mml:mo accent="true">̂</mml:mo>
                      </mml:mover>
                      <mml:mo>,</mml:mo>
                      <mml:msub>
                        <mml:mi>τ</mml:mi>
                        <mml:mi>η</mml:mi>
                      </mml:msub>
                      <mml:mo>∼</mml:mo>
                      <mml:mi mathvariant="normal">N</mml:mi>
                      <mml:mrow>
                        <mml:mo stretchy="true" form="prefix">(</mml:mo>
                        <mml:msub>
                          <mml:mi>μ</mml:mi>
                          <mml:mtext mathvariant="normal">post</mml:mtext>
                        </mml:msub>
                        <mml:mo>,</mml:mo>
                        <mml:msub>
                          <mml:mi>Q</mml:mi>
                          <mml:mtext mathvariant="normal">post</mml:mtext>
                        </mml:msub>
                        <mml:mo stretchy="true" form="postfix">)</mml:mo>
                      </mml:mrow>
                      <mml:mo>,</mml:mo>
                    </mml:mrow>
                  </mml:math>
                </alternatives>
              </disp-formula>
            </p>
            <p>where</p>
            <p>
              <disp-formula>
                <alternatives>
                  <tex-math><![CDATA[
        Q_{\text{post}} = Q_{\eta y} + Q_\eta
        \qquad
        \text{and}
        \qquad
        \mu_{\text{post}} = Q_{\text{post}}^{-1}Q_{\eta y}\hat\eta.
        ]]></tex-math>
                  <mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="block">
                    <mml:mrow>
                      <mml:msub>
                        <mml:mi>Q</mml:mi>
                        <mml:mtext mathvariant="normal">post</mml:mtext>
                      </mml:msub>
                      <mml:mo>=</mml:mo>
                      <mml:msub>
                        <mml:mi>Q</mml:mi>
                        <mml:mrow>
                          <mml:mi>η</mml:mi>
                          <mml:mi>y</mml:mi>
                        </mml:mrow>
                      </mml:msub>
                      <mml:mo>+</mml:mo>
                      <mml:msub>
                        <mml:mi>Q</mml:mi>
                        <mml:mi>η</mml:mi>
                      </mml:msub>
                      <mml:mspace width="2.0em"/>
                      <mml:mtext mathvariant="normal">and</mml:mtext>
                      <mml:mspace width="2.0em"/>
                      <mml:msub>
                        <mml:mi>μ</mml:mi>
                        <mml:mtext mathvariant="normal">post</mml:mtext>
                      </mml:msub>
                      <mml:mo>=</mml:mo>
                      <mml:msubsup>
                        <mml:mi>Q</mml:mi>
                        <mml:mtext mathvariant="normal">post</mml:mtext>
                        <mml:mrow>
                          <mml:mi>−</mml:mi>
                          <mml:mn>1</mml:mn>
                        </mml:mrow>
                      </mml:msubsup>
                      <mml:msub>
                        <mml:mi>Q</mml:mi>
                        <mml:mrow>
                          <mml:mi>η</mml:mi>
                          <mml:mi>y</mml:mi>
                        </mml:mrow>
                      </mml:msub>
                      <mml:mover>
                        <mml:mi>η</mml:mi>
                        <mml:mo accent="true">̂</mml:mo>
                      </mml:mover>
                      <mml:mi>.</mml:mi>
                    </mml:mrow>
                  </mml:math>
                </alternatives>
              </disp-formula>
            </p>
            <p>The first thing we can do to make these calculations faster
        is to precompute <inline-formula><alternatives><tex-math><![CDATA[\hat b_{\eta y} = Q_{\eta y} \hat \eta]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:mrow><mml:msub><mml:mover><mml:mi>b</mml:mi><mml:mo accent="true">̂</mml:mo></mml:mover><mml:mrow><mml:mi>η</mml:mi><mml:mi>y</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mi>Q</mml:mi><mml:mrow><mml:mi>η</mml:mi><mml:mi>y</mml:mi></mml:mrow></mml:msub><mml:mover><mml:mi>η</mml:mi><mml:mo accent="true">̂</mml:mo></mml:mover></mml:mrow></mml:math></alternatives></inline-formula>
        between the Max step and the Smooth step, giving us</p>
            <p>
              <disp-formula>
                <alternatives>
                  <tex-math><![CDATA[
        Q_{\text{post}} = Q_{\eta y} + Q_\eta
        \qquad
        \text{and}
        \qquad
        \mu_{\text{post}} = Q_{\text{post}}^{-1}\hat b_{\eta y}.
        ]]></tex-math>
                  <mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="block">
                    <mml:mrow>
                      <mml:msub>
                        <mml:mi>Q</mml:mi>
                        <mml:mtext mathvariant="normal">post</mml:mtext>
                      </mml:msub>
                      <mml:mo>=</mml:mo>
                      <mml:msub>
                        <mml:mi>Q</mml:mi>
                        <mml:mrow>
                          <mml:mi>η</mml:mi>
                          <mml:mi>y</mml:mi>
                        </mml:mrow>
                      </mml:msub>
                      <mml:mo>+</mml:mo>
                      <mml:msub>
                        <mml:mi>Q</mml:mi>
                        <mml:mi>η</mml:mi>
                      </mml:msub>
                      <mml:mspace width="2.0em"/>
                      <mml:mtext mathvariant="normal">and</mml:mtext>
                      <mml:mspace width="2.0em"/>
                      <mml:msub>
                        <mml:mi>μ</mml:mi>
                        <mml:mtext mathvariant="normal">post</mml:mtext>
                      </mml:msub>
                      <mml:mo>=</mml:mo>
                      <mml:msubsup>
                        <mml:mi>Q</mml:mi>
                        <mml:mtext mathvariant="normal">post</mml:mtext>
                        <mml:mrow>
                          <mml:mi>−</mml:mi>
                          <mml:mn>1</mml:mn>
                        </mml:mrow>
                      </mml:msubsup>
                      <mml:msub>
                        <mml:mover>
                          <mml:mi>b</mml:mi>
                          <mml:mo accent="true">̂</mml:mo>
                        </mml:mover>
                        <mml:mrow>
                          <mml:mi>η</mml:mi>
                          <mml:mi>y</mml:mi>
                        </mml:mrow>
                      </mml:msub>
                      <mml:mi>.</mml:mi>
                    </mml:mrow>
                  </mml:math>
                </alternatives>
              </disp-formula>
            </p>
            <p>The most efficient way to sample from this posterior is to
        calculate the Cholesky decomposition</p>
            <p>
              <disp-formula>
                <alternatives>
                  <tex-math><![CDATA[
        Q_{\text{post}} = L_{\text{post}}L_{\text{post}}^T,
        ]]></tex-math>
                  <mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="block">
                    <mml:mrow>
                      <mml:msub>
                        <mml:mi>Q</mml:mi>
                        <mml:mtext mathvariant="normal">post</mml:mtext>
                      </mml:msub>
                      <mml:mo>=</mml:mo>
                      <mml:msub>
                        <mml:mi>L</mml:mi>
                        <mml:mtext mathvariant="normal">post</mml:mtext>
                      </mml:msub>
                      <mml:msubsup>
                        <mml:mi>L</mml:mi>
                        <mml:mtext mathvariant="normal">post</mml:mtext>
                        <mml:mi>T</mml:mi>
                      </mml:msubsup>
                      <mml:mo>,</mml:mo>
                    </mml:mrow>
                  </mml:math>
                </alternatives>
              </disp-formula>
            </p>
            <p>and using that to solve for <inline-formula><alternatives><tex-math><![CDATA[\mu_\text{post}]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:msub><mml:mi>μ</mml:mi><mml:mtext mathvariant="normal">post</mml:mtext></mml:msub></mml:math></alternatives></inline-formula>
        in</p>
            <p>
              <disp-formula>
                <alternatives>
                  <tex-math><![CDATA[
        L_{\text{post}}L_{\text{post}}^T \mu_\text{post} = \hat b_{\eta y}.
        ]]></tex-math>
                  <mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="block">
                    <mml:mrow>
                      <mml:msub>
                        <mml:mi>L</mml:mi>
                        <mml:mtext mathvariant="normal">post</mml:mtext>
                      </mml:msub>
                      <mml:msubsup>
                        <mml:mi>L</mml:mi>
                        <mml:mtext mathvariant="normal">post</mml:mtext>
                        <mml:mi>T</mml:mi>
                      </mml:msubsup>
                      <mml:msub>
                        <mml:mi>μ</mml:mi>
                        <mml:mtext mathvariant="normal">post</mml:mtext>
                      </mml:msub>
                      <mml:mo>=</mml:mo>
                      <mml:msub>
                        <mml:mover>
                          <mml:mi>b</mml:mi>
                          <mml:mo accent="true">̂</mml:mo>
                        </mml:mover>
                        <mml:mrow>
                          <mml:mi>η</mml:mi>
                          <mml:mi>y</mml:mi>
                        </mml:mrow>
                      </mml:msub>
                      <mml:mi>.</mml:mi>
                    </mml:mrow>
                  </mml:math>
                </alternatives>
              </disp-formula>
            </p>
            <sec id="cholesky-decomposition-of-q_textpost">
              <title>Cholesky Decomposition of
          <inline-formula><alternatives><tex-math><![CDATA[Q_\text{post}]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:msub><mml:mi>Q</mml:mi><mml:mtext mathvariant="normal">post</mml:mtext></mml:msub></mml:math></alternatives></inline-formula></title>
              <p>We first write out <inline-formula><alternatives><tex-math><![CDATA[Q_\text{post}]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:msub><mml:mi>Q</mml:mi><mml:mtext mathvariant="normal">post</mml:mtext></mml:msub></mml:math></alternatives></inline-formula>
          as</p>
              <p>
                <disp-formula>
                  <alternatives>
                    <tex-math><![CDATA[
          Q_\text{post} = \begin{bmatrix}
          Q_{\psi\psi} + \tau_\psi Q_\text{prior} & Q_{\psi\tau} & Q_{\psi\phi} \\
          Q_{\tau\psi} & Q_{\tau\tau} + \tau_\tau Q_\text{prior} & Q_{\tau\phi} \\
          Q_{\phi\psi} & Q_{\phi\tau} & Q_{\phi\phi} + \tau_\phi Q_\text{prior},
          \end{bmatrix}
          ]]></tex-math>
                    <mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="block">
                      <mml:mrow>
                        <mml:msub>
                          <mml:mi>Q</mml:mi>
                          <mml:mtext mathvariant="normal">post</mml:mtext>
                        </mml:msub>
                        <mml:mo>=</mml:mo>
                        <mml:mrow>
                          <mml:mo stretchy="true" form="prefix">[</mml:mo>
                          <mml:mtable>
                            <mml:mtr>
                              <mml:mtd columnalign="center" style="text-align: center">
                                <mml:msub>
                                  <mml:mi>Q</mml:mi>
                                  <mml:mrow>
                                    <mml:mi>ψ</mml:mi>
                                    <mml:mi>ψ</mml:mi>
                                  </mml:mrow>
                                </mml:msub>
                                <mml:mo>+</mml:mo>
                                <mml:msub>
                                  <mml:mi>τ</mml:mi>
                                  <mml:mi>ψ</mml:mi>
                                </mml:msub>
                                <mml:msub>
                                  <mml:mi>Q</mml:mi>
                                  <mml:mtext mathvariant="normal">prior</mml:mtext>
                                </mml:msub>
                              </mml:mtd>
                              <mml:mtd columnalign="center" style="text-align: center">
                                <mml:msub>
                                  <mml:mi>Q</mml:mi>
                                  <mml:mrow>
                                    <mml:mi>ψ</mml:mi>
                                    <mml:mi>τ</mml:mi>
                                  </mml:mrow>
                                </mml:msub>
                              </mml:mtd>
                              <mml:mtd columnalign="center" style="text-align: center">
                                <mml:msub>
                                  <mml:mi>Q</mml:mi>
                                  <mml:mrow>
                                    <mml:mi>ψ</mml:mi>
                                    <mml:mi>ϕ</mml:mi>
                                  </mml:mrow>
                                </mml:msub>
                              </mml:mtd>
                            </mml:mtr>
                            <mml:mtr>
                              <mml:mtd columnalign="center" style="text-align: center">
                                <mml:msub>
                                  <mml:mi>Q</mml:mi>
                                  <mml:mrow>
                                    <mml:mi>τ</mml:mi>
                                    <mml:mi>ψ</mml:mi>
                                  </mml:mrow>
                                </mml:msub>
                              </mml:mtd>
                              <mml:mtd columnalign="center" style="text-align: center">
                                <mml:msub>
                                  <mml:mi>Q</mml:mi>
                                  <mml:mrow>
                                    <mml:mi>τ</mml:mi>
                                    <mml:mi>τ</mml:mi>
                                  </mml:mrow>
                                </mml:msub>
                                <mml:mo>+</mml:mo>
                                <mml:msub>
                                  <mml:mi>τ</mml:mi>
                                  <mml:mi>τ</mml:mi>
                                </mml:msub>
                                <mml:msub>
                                  <mml:mi>Q</mml:mi>
                                  <mml:mtext mathvariant="normal">prior</mml:mtext>
                                </mml:msub>
                              </mml:mtd>
                              <mml:mtd columnalign="center" style="text-align: center">
                                <mml:msub>
                                  <mml:mi>Q</mml:mi>
                                  <mml:mrow>
                                    <mml:mi>τ</mml:mi>
                                    <mml:mi>ϕ</mml:mi>
                                  </mml:mrow>
                                </mml:msub>
                              </mml:mtd>
                            </mml:mtr>
                            <mml:mtr>
                              <mml:mtd columnalign="center" style="text-align: center">
                                <mml:msub>
                                  <mml:mi>Q</mml:mi>
                                  <mml:mrow>
                                    <mml:mi>ϕ</mml:mi>
                                    <mml:mi>ψ</mml:mi>
                                  </mml:mrow>
                                </mml:msub>
                              </mml:mtd>
                              <mml:mtd columnalign="center" style="text-align: center">
                                <mml:msub>
                                  <mml:mi>Q</mml:mi>
                                  <mml:mrow>
                                    <mml:mi>ϕ</mml:mi>
                                    <mml:mi>τ</mml:mi>
                                  </mml:mrow>
                                </mml:msub>
                              </mml:mtd>
                              <mml:mtd columnalign="center" style="text-align: center">
                                <mml:msub>
                                  <mml:mi>Q</mml:mi>
                                  <mml:mrow>
                                    <mml:mi>ϕ</mml:mi>
                                    <mml:mi>ϕ</mml:mi>
                                  </mml:mrow>
                                </mml:msub>
                                <mml:mo>+</mml:mo>
                                <mml:msub>
                                  <mml:mi>τ</mml:mi>
                                  <mml:mi>ϕ</mml:mi>
                                </mml:msub>
                                <mml:msub>
                                  <mml:mi>Q</mml:mi>
                                  <mml:mtext mathvariant="normal">prior</mml:mtext>
                                </mml:msub>
                                <mml:mo>,</mml:mo>
                              </mml:mtd>
                            </mml:mtr>
                          </mml:mtable>
                          <mml:mo stretchy="true" form="postfix">]</mml:mo>
                        </mml:mrow>
                      </mml:mrow>
                    </mml:math>
                  </alternatives>
                </disp-formula>
              </p>
              <p>where each block on the diagonal has bandwidth 3 and all
          the off-diagonal blocks are diagonal matrices. Keep in mind
          that since the off-diagonal blocks are diagonal matrices we
          have that <inline-formula><alternatives><tex-math><![CDATA[Q_{\psi\tau} = Q_{\tau\psi}]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:mrow><mml:msub><mml:mi>Q</mml:mi><mml:mrow><mml:mi>ψ</mml:mi><mml:mi>τ</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mi>Q</mml:mi><mml:mrow><mml:mi>τ</mml:mi><mml:mi>ψ</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:math></alternatives></inline-formula>,
          <inline-formula><alternatives><tex-math><![CDATA[Q_{\psi\phi} = Q_{\phi\psi}]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:mrow><mml:msub><mml:mi>Q</mml:mi><mml:mrow><mml:mi>ψ</mml:mi><mml:mi>ϕ</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mi>Q</mml:mi><mml:mrow><mml:mi>ϕ</mml:mi><mml:mi>ψ</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:math></alternatives></inline-formula>
          and <inline-formula><alternatives><tex-math><![CDATA[Q_{\tau\phi} = Q_{\phi\tau}]]></tex-math><mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline"><mml:mrow><mml:msub><mml:mi>Q</mml:mi><mml:mrow><mml:mi>τ</mml:mi><mml:mi>ϕ</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mi>Q</mml:mi><mml:mrow><mml:mi>ϕ</mml:mi><mml:mi>τ</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:math></alternatives></inline-formula>.We
          can thus calculate the Cholesky decomposition</p>
              <p>
                <disp-formula>
                  <alternatives>
                    <tex-math><![CDATA[
          L_\text{post} = \begin{bmatrix}
          L_{11} & 0 & 0 \\
          L_{21} & L_{22} & 0 \\
          L_{31} & L_{32} & L_{33},
          \end{bmatrix}
          ]]></tex-math>
                    <mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="block">
                      <mml:mrow>
                        <mml:msub>
                          <mml:mi>L</mml:mi>
                          <mml:mtext mathvariant="normal">post</mml:mtext>
                        </mml:msub>
                        <mml:mo>=</mml:mo>
                        <mml:mrow>
                          <mml:mo stretchy="true" form="prefix">[</mml:mo>
                          <mml:mtable>
                            <mml:mtr>
                              <mml:mtd columnalign="center" style="text-align: center">
                                <mml:msub>
                                  <mml:mi>L</mml:mi>
                                  <mml:mn>11</mml:mn>
                                </mml:msub>
                              </mml:mtd>
                              <mml:mtd columnalign="center" style="text-align: center">
                                <mml:mn>0</mml:mn>
                              </mml:mtd>
                              <mml:mtd columnalign="center" style="text-align: center">
                                <mml:mn>0</mml:mn>
                              </mml:mtd>
                            </mml:mtr>
                            <mml:mtr>
                              <mml:mtd columnalign="center" style="text-align: center">
                                <mml:msub>
                                  <mml:mi>L</mml:mi>
                                  <mml:mn>21</mml:mn>
                                </mml:msub>
                              </mml:mtd>
                              <mml:mtd columnalign="center" style="text-align: center">
                                <mml:msub>
                                  <mml:mi>L</mml:mi>
                                  <mml:mn>22</mml:mn>
                                </mml:msub>
                              </mml:mtd>
                              <mml:mtd columnalign="center" style="text-align: center">
                                <mml:mn>0</mml:mn>
                              </mml:mtd>
                            </mml:mtr>
                            <mml:mtr>
                              <mml:mtd columnalign="center" style="text-align: center">
                                <mml:msub>
                                  <mml:mi>L</mml:mi>
                                  <mml:mn>31</mml:mn>
                                </mml:msub>
                              </mml:mtd>
                              <mml:mtd columnalign="center" style="text-align: center">
                                <mml:msub>
                                  <mml:mi>L</mml:mi>
                                  <mml:mn>32</mml:mn>
                                </mml:msub>
                              </mml:mtd>
                              <mml:mtd columnalign="center" style="text-align: center">
                                <mml:msub>
                                  <mml:mi>L</mml:mi>
                                  <mml:mn>33</mml:mn>
                                </mml:msub>
                                <mml:mo>,</mml:mo>
                              </mml:mtd>
                            </mml:mtr>
                          </mml:mtable>
                          <mml:mo stretchy="true" form="postfix">]</mml:mo>
                        </mml:mrow>
                      </mml:mrow>
                    </mml:math>
                  </alternatives>
                </disp-formula>
              </p>
              <p>efficiently using a block-Cholesky factorization:</p>
              <list list-type="order">
                <list-item>
                  <p>
                    <inline-formula>
                      <alternatives>
                        <tex-math><![CDATA[L_{11} = \mathrm{Chol}(Q_{\psi\psi} + \tau_\psi Q_\text{prior})]]></tex-math>
                        <mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline">
                          <mml:mrow>
                            <mml:msub>
                              <mml:mi>L</mml:mi>
                              <mml:mn>11</mml:mn>
                            </mml:msub>
                            <mml:mo>=</mml:mo>
                            <mml:mrow>
                              <mml:mi mathvariant="normal">C</mml:mi>
                              <mml:mi mathvariant="normal">h</mml:mi>
                              <mml:mi mathvariant="normal">o</mml:mi>
                              <mml:mi mathvariant="normal">l</mml:mi>
                            </mml:mrow>
                            <mml:mrow>
                              <mml:mo stretchy="true" form="prefix">(</mml:mo>
                              <mml:msub>
                                <mml:mi>Q</mml:mi>
                                <mml:mrow>
                                  <mml:mi>ψ</mml:mi>
                                  <mml:mi>ψ</mml:mi>
                                </mml:mrow>
                              </mml:msub>
                              <mml:mo>+</mml:mo>
                              <mml:msub>
                                <mml:mi>τ</mml:mi>
                                <mml:mi>ψ</mml:mi>
                              </mml:msub>
                              <mml:msub>
                                <mml:mi>Q</mml:mi>
                                <mml:mtext mathvariant="normal">prior</mml:mtext>
                              </mml:msub>
                              <mml:mo stretchy="true" form="postfix">)</mml:mo>
                            </mml:mrow>
                          </mml:mrow>
                        </mml:math>
                      </alternatives>
                    </inline-formula>
                  </p>
                </list-item>
                <list-item>
                  <p>
                    <inline-formula>
                      <alternatives>
                        <tex-math><![CDATA[L_{21} = Q_{\psi\tau}L_{11}^{-T}]]></tex-math>
                        <mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline">
                          <mml:mrow>
                            <mml:msub>
                              <mml:mi>L</mml:mi>
                              <mml:mn>21</mml:mn>
                            </mml:msub>
                            <mml:mo>=</mml:mo>
                            <mml:msub>
                              <mml:mi>Q</mml:mi>
                              <mml:mrow>
                                <mml:mi>ψ</mml:mi>
                                <mml:mi>τ</mml:mi>
                              </mml:mrow>
                            </mml:msub>
                            <mml:msubsup>
                              <mml:mi>L</mml:mi>
                              <mml:mn>11</mml:mn>
                              <mml:mrow>
                                <mml:mi>−</mml:mi>
                                <mml:mi>T</mml:mi>
                              </mml:mrow>
                            </mml:msubsup>
                          </mml:mrow>
                        </mml:math>
                      </alternatives>
                    </inline-formula>
                  </p>
                </list-item>
                <list-item>
                  <p>
                    <inline-formula>
                      <alternatives>
                        <tex-math><![CDATA[L_{31} = Q_{\psi\phi}L_{11}^{-T}]]></tex-math>
                        <mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline">
                          <mml:mrow>
                            <mml:msub>
                              <mml:mi>L</mml:mi>
                              <mml:mn>31</mml:mn>
                            </mml:msub>
                            <mml:mo>=</mml:mo>
                            <mml:msub>
                              <mml:mi>Q</mml:mi>
                              <mml:mrow>
                                <mml:mi>ψ</mml:mi>
                                <mml:mi>ϕ</mml:mi>
                              </mml:mrow>
                            </mml:msub>
                            <mml:msubsup>
                              <mml:mi>L</mml:mi>
                              <mml:mn>11</mml:mn>
                              <mml:mrow>
                                <mml:mi>−</mml:mi>
                                <mml:mi>T</mml:mi>
                              </mml:mrow>
                            </mml:msubsup>
                          </mml:mrow>
                        </mml:math>
                      </alternatives>
                    </inline-formula>
                  </p>
                </list-item>
                <list-item>
                  <p>
                    <inline-formula>
                      <alternatives>
                        <tex-math><![CDATA[L_{22} = \mathrm{Chol}(S_{22})]]></tex-math>
                        <mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline">
                          <mml:mrow>
                            <mml:msub>
                              <mml:mi>L</mml:mi>
                              <mml:mn>22</mml:mn>
                            </mml:msub>
                            <mml:mo>=</mml:mo>
                            <mml:mrow>
                              <mml:mi mathvariant="normal">C</mml:mi>
                              <mml:mi mathvariant="normal">h</mml:mi>
                              <mml:mi mathvariant="normal">o</mml:mi>
                              <mml:mi mathvariant="normal">l</mml:mi>
                            </mml:mrow>
                            <mml:mrow>
                              <mml:mo stretchy="true" form="prefix">(</mml:mo>
                              <mml:msub>
                                <mml:mi>S</mml:mi>
                                <mml:mn>22</mml:mn>
                              </mml:msub>
                              <mml:mo stretchy="true" form="postfix">)</mml:mo>
                            </mml:mrow>
                          </mml:mrow>
                        </mml:math>
                      </alternatives>
                    </inline-formula>
                  </p>
                  <list list-type="bullet">
                    <list-item>
                      <p>
                        <inline-formula>
                          <alternatives>
                            <tex-math><![CDATA[S_{22} = \left(Q_{\tau\tau} + \tau_\tau Q_\text{prior}\right) - L_{21}L_{21}^T]]></tex-math>
                            <mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline">
                              <mml:mrow>
                                <mml:msub>
                                  <mml:mi>S</mml:mi>
                                  <mml:mn>22</mml:mn>
                                </mml:msub>
                                <mml:mo>=</mml:mo>
                                <mml:mrow>
                                  <mml:mo stretchy="true" form="prefix">(</mml:mo>
                                  <mml:msub>
                                    <mml:mi>Q</mml:mi>
                                    <mml:mrow>
                                      <mml:mi>τ</mml:mi>
                                      <mml:mi>τ</mml:mi>
                                    </mml:mrow>
                                  </mml:msub>
                                  <mml:mo>+</mml:mo>
                                  <mml:msub>
                                    <mml:mi>τ</mml:mi>
                                    <mml:mi>τ</mml:mi>
                                  </mml:msub>
                                  <mml:msub>
                                    <mml:mi>Q</mml:mi>
                                    <mml:mtext mathvariant="normal">prior</mml:mtext>
                                  </mml:msub>
                                  <mml:mo stretchy="true" form="postfix">)</mml:mo>
                                </mml:mrow>
                                <mml:mo>−</mml:mo>
                                <mml:msub>
                                  <mml:mi>L</mml:mi>
                                  <mml:mn>21</mml:mn>
                                </mml:msub>
                                <mml:msubsup>
                                  <mml:mi>L</mml:mi>
                                  <mml:mn>21</mml:mn>
                                  <mml:mi>T</mml:mi>
                                </mml:msubsup>
                              </mml:mrow>
                            </mml:math>
                          </alternatives>
                        </inline-formula>
                      </p>
                    </list-item>
                  </list>
                </list-item>
                <list-item>
                  <p>
                    <inline-formula>
                      <alternatives>
                        <tex-math><![CDATA[L_{32} = \left(Q_{\phi\tau} - L_{31}L_{21}^T\right)L_{22}^{-T}]]></tex-math>
                        <mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline">
                          <mml:mrow>
                            <mml:msub>
                              <mml:mi>L</mml:mi>
                              <mml:mn>32</mml:mn>
                            </mml:msub>
                            <mml:mo>=</mml:mo>
                            <mml:mrow>
                              <mml:mo stretchy="true" form="prefix">(</mml:mo>
                              <mml:msub>
                                <mml:mi>Q</mml:mi>
                                <mml:mrow>
                                  <mml:mi>ϕ</mml:mi>
                                  <mml:mi>τ</mml:mi>
                                </mml:mrow>
                              </mml:msub>
                              <mml:mo>−</mml:mo>
                              <mml:msub>
                                <mml:mi>L</mml:mi>
                                <mml:mn>31</mml:mn>
                              </mml:msub>
                              <mml:msubsup>
                                <mml:mi>L</mml:mi>
                                <mml:mn>21</mml:mn>
                                <mml:mi>T</mml:mi>
                              </mml:msubsup>
                              <mml:mo stretchy="true" form="postfix">)</mml:mo>
                            </mml:mrow>
                            <mml:msubsup>
                              <mml:mi>L</mml:mi>
                              <mml:mn>22</mml:mn>
                              <mml:mrow>
                                <mml:mi>−</mml:mi>
                                <mml:mi>T</mml:mi>
                              </mml:mrow>
                            </mml:msubsup>
                          </mml:mrow>
                        </mml:math>
                      </alternatives>
                    </inline-formula>
                  </p>
                </list-item>
                <list-item>
                  <p>
                    <inline-formula>
                      <alternatives>
                        <tex-math><![CDATA[L_{33} = \mathrm{Chol}(S_{33})]]></tex-math>
                        <mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline">
                          <mml:mrow>
                            <mml:msub>
                              <mml:mi>L</mml:mi>
                              <mml:mn>33</mml:mn>
                            </mml:msub>
                            <mml:mo>=</mml:mo>
                            <mml:mrow>
                              <mml:mi mathvariant="normal">C</mml:mi>
                              <mml:mi mathvariant="normal">h</mml:mi>
                              <mml:mi mathvariant="normal">o</mml:mi>
                              <mml:mi mathvariant="normal">l</mml:mi>
                            </mml:mrow>
                            <mml:mrow>
                              <mml:mo stretchy="true" form="prefix">(</mml:mo>
                              <mml:msub>
                                <mml:mi>S</mml:mi>
                                <mml:mn>33</mml:mn>
                              </mml:msub>
                              <mml:mo stretchy="true" form="postfix">)</mml:mo>
                            </mml:mrow>
                          </mml:mrow>
                        </mml:math>
                      </alternatives>
                    </inline-formula>
                  </p>
                  <list list-type="bullet">
                    <list-item>
                      <p>
                        <inline-formula>
                          <alternatives>
                            <tex-math><![CDATA[S_{33} = \left( Q_{\phi\phi} + \tau_\phi Q_\text{prior} \right) - L_{31}L_{31}^T - L_{32}L_{32}^T]]></tex-math>
                            <mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML" display="inline">
                              <mml:mrow>
                                <mml:msub>
                                  <mml:mi>S</mml:mi>
                                  <mml:mn>33</mml:mn>
                                </mml:msub>
                                <mml:mo>=</mml:mo>
                                <mml:mrow>
                                  <mml:mo stretchy="true" form="prefix">(</mml:mo>
                                  <mml:msub>
                                    <mml:mi>Q</mml:mi>
                                    <mml:mrow>
                                      <mml:mi>ϕ</mml:mi>
                                      <mml:mi>ϕ</mml:mi>
                                    </mml:mrow>
                                  </mml:msub>
                                  <mml:mo>+</mml:mo>
                                  <mml:msub>
                                    <mml:mi>τ</mml:mi>
                                    <mml:mi>ϕ</mml:mi>
                                  </mml:msub>
                                  <mml:msub>
                                    <mml:mi>Q</mml:mi>
                                    <mml:mtext mathvariant="normal">prior</mml:mtext>
                                  </mml:msub>
                                  <mml:mo stretchy="true" form="postfix">)</mml:mo>
                                </mml:mrow>
                                <mml:mo>−</mml:mo>
                                <mml:msub>
                                  <mml:mi>L</mml:mi>
                                  <mml:mn>31</mml:mn>
                                </mml:msub>
                                <mml:msubsup>
                                  <mml:mi>L</mml:mi>
                                  <mml:mn>31</mml:mn>
                                  <mml:mi>T</mml:mi>
                                </mml:msubsup>
                                <mml:mo>−</mml:mo>
                                <mml:msub>
                                  <mml:mi>L</mml:mi>
                                  <mml:mn>32</mml:mn>
                                </mml:msub>
                                <mml:msubsup>
                                  <mml:mi>L</mml:mi>
                                  <mml:mn>32</mml:mn>
                                  <mml:mi>T</mml:mi>
                                </mml:msubsup>
                              </mml:mrow>
                            </mml:math>
                          </alternatives>
                        </inline-formula>
                      </p>
                    </list-item>
                  </list>
                </list-item>
              </list>
            </sec>
          </sec>
        </sec>
      </sec>
    </sec>
  </body>
  <back>
</back>
</article>
